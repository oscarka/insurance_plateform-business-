# 雇主责任险平台系统设计文档

## 一、系统概述

### 1.1 系统定位

雇主责任险平台是一个面向企业的保险服务平台，主要功能包括：
- 在线投保：企业用户可以在线填写投保信息，提交核保申请
- 保单管理：管理保单信息，支持批改、续保等操作
- 保司对接：与多个保险公司（保司）对接，支持多保司多产品
- 数据管理：管理企业信息、被保人信息、方案配置等

### 1.2 核心特点

1. **多保司支持**：系统可以对接多个保司（如利宝、平安等），每个保司可能有不同的产品和方案
2. **配置化管理**：产品、方案、费率、拦截规则等都通过配置管理，无需修改代码
3. **规则引擎**：支持拦截规则和数据校验规则，确保数据质量和业务合规
4. **完整追溯**：所有关键操作都有日志记录，支持问题排查和审计

---

## 二、系统架构设计

### 2.1 整体架构

系统采用分层架构设计，主要包括：

```
┌─────────────────────────────────────────┐
│           前端展示层（React）              │
│  - 投保页面、保单管理、批改续保等          │
└─────────────────────────────────────────┘
                    ↓
┌─────────────────────────────────────────┐
│         业务逻辑层（后端服务）             │
│  - 投保业务、核保业务、承保业务等          │
│  - 规则引擎、数据校验、保费计算等          │
└─────────────────────────────────────────┘
                    ↓
┌─────────────────────────────────────────┐
│         接口对接层（适配器模式）            │
│  - 渠道适配、字段映射、数据转换等          │
│  - 接口调用、日志记录、异常处理等          │
└─────────────────────────────────────────┘
                    ↓
┌─────────────────────────────────────────┐
│         数据持久层（数据库）               │
│  - 业务数据、配置数据、日志数据等          │
└─────────────────────────────────────────┘
```

### 2.2 核心模块

#### 2.2.1 投保模块

**功能**：
- 企业信息录入
- 产品选择
- 责任和保额选择
- 方案配置
- 被保人信息录入
- 保费计算
- 投保单提交

**设计要点**：
- 支持草稿保存，用户可以分步填写
- 产品选择后，动态加载产品支持的责任和保额选项
- 用户从责任选项中选择具体的保额值
- 支持批量导入被保人信息
- 实时计算保费，展示保费明细
- 数据校验，确保数据完整性

**责任管理流程**：
1. 用户选择产品后，系统从 `product_liabilities` 表查询产品支持的责任
2. 展示每个责任的保额选项（如下拉框）
3. 用户选择具体的保额值
4. 系统创建 `plan_liabilities` 记录，存储选择的责任和保额
5. 根据选择的责任和保额计算保费

#### 2.2.2 核保模块

**功能**：
- 核保申请提交
- 核保状态查询
- 核保结果处理

**设计要点**：
- 异步处理，避免阻塞用户操作
- 支持任务重试，提高成功率
- 完整的日志记录，便于问题排查
- 状态机管理，确保流程正确

#### 2.2.3 承保模块

**功能**：
- 承保申请提交
- 拦截规则检查
- 数据转换和接口调用
- 保单生成

**设计要点**：
- **拦截规则引擎**：在调用保司接口前，检查数据是否符合规则
- **字段映射**：系统字段与保司接口字段的自动转换
- **异常处理**：接口失败时的重试和人工处理机制
- **状态同步**：本地状态与保司状态的同步

#### 2.2.4 批改模块

**功能**：
- 增员申请
- 减员申请
- 替换申请
- 批改审核

**设计要点**：
- 支持批量操作
- 记录批改前后的变化
- 保费自动计算
- 批改生效时间管理

#### 2.2.5 配置管理模块

**功能**：
- 责任类型管理
- 保司产品配置
- 产品责任配置
- 产品方案模板配置
- 费率配置
- 拦截规则配置
- 渠道配置
- 字段映射配置

**设计要点**：
- **责任统一管理**：所有责任类型在一个地方定义和管理
- **产品责任配置**：为每个产品配置支持的责任和保额选项
- 配置化管理，支持动态调整
- 版本管理，支持配置历史追溯
- 权限控制，确保配置安全
- 配置验证，确保配置正确性

**责任配置流程**：
1. 在责任表中定义所有责任类型
2. 配置产品时，从责任表中选择产品支持的责任
3. 为每个责任定义保额选项（如：10万、30万、50万等）
4. 用户投保时，从产品责任配置的选项中选择

---

## 三、核心设计模式

### 3.1 适配器模式（渠道对接）

**应用场景**：不同保司的接口可能有不同的字段命名、数据格式等，需要通过适配器进行转换。

**设计思路**：
- 定义统一的内部数据模型
- 通过适配器将内部模型转换为保司接口格式
- 通过字段映射表配置转换规则
- 支持多个适配器，每个保司一个适配器

**优势**：
- 解耦：内部业务逻辑与保司接口解耦
- 扩展：新增保司时，只需新增适配器，无需修改业务逻辑
- 维护：接口变更时，只需修改适配器配置

### 3.2 策略模式（规则引擎）

**应用场景**：不同类型的拦截规则有不同的检查逻辑，需要灵活配置和执行。

**设计思路**：
- 定义规则接口，不同类型的规则实现不同的策略
- 通过规则表配置规则，支持动态加载
- 规则引擎按照优先级顺序执行规则
- 支持规则的启用/禁用和优先级调整

**优势**：
- 灵活：规则可以动态配置，无需修改代码
- 可扩展：新增规则类型时，只需实现新的策略
- 可维护：规则调整时，只需修改配置

### 3.3 责任管理模式

**应用场景**：不同保司、不同产品的责任可能不同，需要灵活配置和管理。

**设计思路**：
- 责任独立管理：责任类型在独立的表中定义
- 产品责任配置：通过关联表配置产品支持的责任和保额选项
- 方案责任选择：用户在方案中选择具体的责任和保额
- 三层架构：责任定义层 → 产品配置层 → 方案选择层

**优势**：
- 灵活：不同产品可以选择不同的责任组合
- 可扩展：新增责任类型时，只需在责任表中添加
- 统一：责任统一管理，避免重复定义
- 符合业务：责任是产品的一部分，方案只是选择了责任和保额

---

## 四、数据流转设计

### 4.1 投保流程数据流转

```
用户填写信息
    ↓
创建 companies 记录（如果不存在）
    ↓
创建 insurance_plans 记录（方案配置）
    ↓
创建 applications 记录（状态：草稿）
    ↓
创建 application_plans 关联记录
    ↓
创建 insured_persons 记录（被保人信息）
    ↓
用户提交投保
    ↓
数据校验（data_validation_rules）
    ↓
更新 applications 状态为"待核保"
    ↓
创建 insurance_api_tasks 任务
    ↓
数据转换（api_field_mappings）
    ↓
调用保司核保接口
    ↓
记录 insurance_api_logs
    ↓
更新 applications 状态为"核保通过"
```

### 4.2 承保流程数据流转

```
核保通过
    ↓
创建承保任务
    ↓
拦截规则检查（underwriting_intercept_rules）
    ↓
规则通过？
    ├─ 否 → 记录拦截原因，任务失败
    └─ 是 → 继续
    ↓
数据转换（api_field_mappings）
    ↓
调用保司承保接口
    ↓
记录 insurance_api_logs
    ↓
承保成功？
    ├─ 否 → 记录错误，支持重试
    └─ 是 → 继续
    ↓
创建 policies 记录
    ↓
更新 applications 状态为"已承保"
```

### 4.3 保费计算流程

```
用户选择产品
    ↓
查询 product_liabilities 表，获取产品支持的责任和保额选项
    ↓
用户选择责任和保额
    ↓
创建 plan_liabilities 记录，存储选择的责任和保额
    ↓
用户填写被保人信息（职业类别等）
    ↓
根据被保人职业类别、选择的责任和保额
    ↓
查询 premium_rates 表，获取每个责任的费率
    ↓
计算每个责任的保费 = 基础费率 × 费率系数
    ↓
汇总所有责任的保费，得到个人保费
    ↓
汇总所有被保人的保费
    ↓
展示总保费和明细
```

---

## 五、接口对接设计

### 5.1 接口对接架构

```
业务层
    ↓
接口适配层（根据渠道选择适配器）
    ↓
字段映射层（系统字段 → 保司字段）
    ↓
数据转换层（格式转换、数据校验）
    ↓
拦截规则层（业务规则检查）
    ↓
HTTP客户端（调用保司接口）
    ↓
响应处理层（解析响应、错误处理）
    ↓
数据同步层（更新本地数据）
```

### 5.2 接口对接流程

1. **渠道选择**
   - 根据保司和产品选择对应的渠道
   - 加载渠道的接口配置（地址、认证信息等）

2. **数据准备**
   - 从业务表查询数据
   - 根据字段映射表转换字段名
   - 进行数据格式转换

3. **规则检查**
   - 查询拦截规则表
   - 按照优先级检查规则
   - 规则拦截则返回错误

4. **接口调用**
   - 构建请求数据
   - 调用保司接口
   - 记录请求和响应日志

5. **响应处理**
   - 解析响应数据
   - 根据响应更新本地数据
   - 处理异常情况

### 5.3 接口对接的关键设计

#### 5.3.1 字段映射机制

**设计目的**：不同保司的接口字段命名可能不同，需要自动转换。

**实现方式**：
- 在 `api_field_mappings` 表中配置字段映射关系
- 系统字段 → 保司接口字段的映射
- 支持格式转换（如日期格式、金额格式等）
- 支持默认值和必填校验

**使用场景**：
- 调用保司接口前，自动转换字段名和格式
- 新增保司时，只需配置字段映射，无需修改代码

#### 5.3.2 拦截规则机制

**设计目的**：在调用保司接口前，检查数据是否符合规则，避免无效调用。

**实现方式**：
- 在 `underwriting_intercept_rules` 表中配置拦截规则
- 规则类型：数据校验、业务规则、风控规则等
- 支持多种检查操作符（等于、大于、小于、包含、正则匹配等）
- 按照优先级顺序执行规则

**使用场景**：
- 承保前检查被保人数、保费范围等
- 检查企业风控等级、被保人职业类别等
- 提前发现数据问题，提供友好错误提示

#### 5.3.3 异步任务机制

**设计目的**：接口调用可能耗时较长，需要异步处理，避免阻塞用户操作。

**实现方式**：
- 在 `insurance_api_tasks` 表中创建任务
- 任务状态：待处理、处理中、成功、失败
- 支持任务重试机制
- 定时任务扫描待处理任务，调用接口

**使用场景**：
- 核保、承保等耗时操作
- 支持任务重试，提高成功率
- 任务失败时，支持人工处理

---

## 六、规则引擎设计

### 6.1 规则引擎架构

```
规则配置表（数据库）
    ↓
规则加载器（从数据库加载规则）
    ↓
规则执行器（按照优先级执行规则）
    ↓
规则策略（不同类型的规则实现不同的策略）
    ↓
规则结果（通过/拦截 + 错误信息）
```

### 6.2 规则类型

#### 6.2.1 数据校验规则

**作用**：检查字段格式、长度、范围等。

**示例**：
- 身份证号格式校验
- 手机号格式校验
- 统一社会信用代码格式校验
- 金额范围校验

**配置方式**：
- 在 `data_validation_rules` 表中配置
- 支持正则表达式、长度、范围等校验

#### 6.2.2 业务规则

**作用**：检查业务逻辑是否符合要求。

**示例**：
- 被保人数限制（如：1-100人）
- 保费范围检查（如：最低1000元）
- 职业类别检查（如：5类职业需要加费）
- 生效日期检查（如：不能早于今天）

**配置方式**：
- 在 `underwriting_intercept_rules` 表中配置
- 支持多种检查操作符

#### 6.2.3 风控规则

**作用**：检查风控相关信息。

**示例**：
- 企业风控等级检查（高风险企业可能被拦截）
- 被保人年龄检查（如：18-65岁）
- 职业风险检查（高危职业可能被拦截）

**配置方式**：
- 在 `underwriting_intercept_rules` 表中配置
- 可以关联企业风控数据

### 6.3 规则执行流程

1. **规则加载**
   - 根据业务类型（如：承保）查询相关规则
   - 过滤掉禁用的规则
   - 按照优先级排序

2. **规则执行**
   - 依次执行每个规则
   - 如果规则拦截，立即返回错误信息
   - 如果所有规则通过，继续业务流程

3. **结果处理**
   - 规则拦截：记录拦截原因，返回错误信息
   - 规则通过：继续业务流程

---

## 七、配置管理设计

### 7.1 配置管理架构

```
配置表（数据库）
    ↓
配置加载器（从数据库加载配置）
    ↓
配置缓存（内存缓存，提高性能）
    ↓
配置使用（业务逻辑使用配置）
    ↓
配置更新（支持配置热更新）
```

### 7.2 配置类型

#### 7.2.1 产品配置

- **保司产品表**：存储各保司的产品信息
- **产品方案配置表**：存储每个产品的方案配置
- **费率配置表**：存储费率信息

#### 7.2.2 接口配置

- **渠道配置表**：存储渠道的接口配置
- **接口字段映射表**：存储字段映射关系
- **保司接口配置表**：存储保司的接口配置

#### 7.2.3 规则配置

- **拦截规则表**：存储拦截规则
- **数据校验规则表**：存储数据校验规则

### 7.3 配置管理原则

1. **配置与代码分离**：配置存储在数据库中，不硬编码在代码中
2. **配置版本管理**：支持配置的版本管理和历史追溯
3. **配置热更新**：支持配置的动态更新，无需重启服务
4. **配置验证**：配置更新时，进行验证，确保配置正确
5. **配置权限**：配置管理需要权限控制，确保配置安全

---

## 八、异常处理设计

### 8.1 异常分类

#### 8.1.1 数据异常

- **数据格式错误**：字段格式不符合要求
- **数据缺失**：必填字段未填写
- **数据范围错误**：数据超出允许范围

**处理方式**：
- 数据校验规则拦截
- 返回友好的错误提示
- 不允许提交

#### 8.1.2 业务异常

- **业务规则不满足**：不符合业务规则
- **状态异常**：业务流程状态不正确

**处理方式**：
- 拦截规则拦截
- 返回业务错误提示
- 不允许继续流程

#### 8.1.3 接口异常

- **接口调用失败**：网络异常、接口异常等
- **接口返回错误**：保司返回错误信息

**处理方式**：
- 记录错误日志
- 支持任务重试
- 任务失败时，支持人工处理

### 8.2 异常处理流程

```
异常发生
    ↓
异常分类（数据异常/业务异常/接口异常）
    ↓
异常处理（根据异常类型选择处理方式）
    ↓
错误记录（记录到日志表）
    ↓
用户提示（返回友好的错误信息）
    ↓
异常恢复（支持重试或人工处理）
```

---

## 九、性能优化设计

### 9.1 数据库优化

1. **索引优化**
   - 为常用查询字段建立索引
   - 为外键字段建立索引
   - 为状态字段建立索引

2. **查询优化**
   - 避免全表扫描
   - 使用分页查询
   - 合理使用缓存

3. **数据归档**
   - 定期归档历史日志
   - 归档过期保单数据

### 9.2 缓存策略

1. **配置缓存**
   - 产品配置、方案配置等可以缓存
   - 配置更新时，清除缓存

2. **查询缓存**
   - 常用查询结果可以缓存
   - 设置合理的缓存过期时间

3. **接口缓存**
   - 保司接口配置可以缓存
   - 减少数据库查询

### 9.3 异步处理

1. **接口调用异步化**
   - 核保、承保等操作异步处理
   - 避免阻塞用户操作

2. **任务队列**
   - 使用任务队列管理异步任务
   - 支持任务优先级和重试

---

## 十、安全设计

### 10.1 数据安全

1. **敏感信息加密**
   - 密码、密钥等敏感信息加密存储
   - 使用安全的加密算法

2. **数据访问控制**
   - 用户只能访问自己的数据
   - 管理员可以访问所有数据

3. **数据备份**
   - 定期备份数据
   - 支持数据恢复

### 10.2 接口安全

1. **接口认证**
   - 使用 app_id 和 app_secret 认证
   - 支持接口签名验证

2. **接口加密**
   - 敏感数据传输加密
   - 使用 HTTPS 协议

3. **接口限流**
   - 限制接口调用频率
   - 防止接口滥用

### 10.3 操作安全

1. **操作日志**
   - 记录所有关键操作
   - 支持操作审计

2. **权限控制**
   - 不同角色有不同的权限
   - 关键操作需要权限验证

---

## 十一、监控与运维

### 11.1 系统监控

1. **性能监控**
   - 接口调用耗时
   - 数据库查询性能
   - 系统资源使用情况

2. **业务监控**
   - 投保成功率
   - 核保通过率
   - 承保成功率
   - 接口调用成功率

3. **异常监控**
   - 接口调用失败率
   - 规则拦截率
   - 系统错误率

### 11.2 日志管理

1. **日志分类**
   - 操作日志：记录用户操作
   - 接口日志：记录接口调用
   - 系统日志：记录系统运行情况

2. **日志存储**
   - 日志存储在数据库中
   - 定期归档历史日志

3. **日志查询**
   - 支持按时间、用户、业务类型等查询
   - 支持日志导出

### 11.3 运维支持

1. **配置管理**
   - 支持配置的动态更新
   - 配置更新需要审核

2. **数据维护**
   - 支持数据的批量导入导出
   - 支持数据的修复和清理

3. **问题排查**
   - 通过日志快速定位问题
   - 支持数据追溯

---

## 十二、扩展性设计

### 12.1 保司扩展

**新增保司的步骤**：
1. 在保司接口配置表中添加保司配置
2. 在渠道配置表中添加渠道配置
3. 在保司产品表中添加产品信息
4. 在产品方案配置表中添加方案配置
5. 在费率配置表中添加费率信息
6. 在接口字段映射表中配置字段映射
7. 在拦截规则表中配置拦截规则

**优势**：
- 无需修改代码
- 配置化管理
- 快速上线

### 12.2 功能扩展

**新增功能的步骤**：
1. 设计数据库表结构
2. 实现业务逻辑
3. 实现接口对接（如需要）
4. 配置相关规则和映射

**优势**：
- 模块化设计
- 低耦合
- 易于维护

---

## 十三、总结

本系统设计遵循以下原则：

1. **配置化管理**：产品、方案、规则等都通过配置管理，提高灵活性
2. **规则引擎**：通过拦截规则和数据校验规则，确保数据质量和业务合规
3. **适配器模式**：通过适配器和字段映射，支持多保司对接
4. **完整追溯**：所有关键操作都有日志记录，支持问题排查和审计
5. **异常处理**：完善的异常处理机制，支持重试和人工处理
6. **性能优化**：合理的索引、缓存、异步处理等，提高系统性能
7. **安全设计**：数据加密、权限控制、操作审计等，确保系统安全
8. **扩展性强**：模块化设计，支持快速扩展

通过以上设计，系统可以灵活支持多保司多产品，具有良好的扩展性和可维护性。

