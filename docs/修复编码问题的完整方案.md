# ä¿®å¤ç¼–ç é—®é¢˜çš„å®Œæ•´æ–¹æ¡ˆ

## ä¸€ã€é—®é¢˜æ ¹æº

### æ ¸å¿ƒé—®é¢˜ï¼šMySQLè¿æ¥å­—ç¬¦é›†é…ç½®ä¸ä¸€è‡´

**å½“å‰çŠ¶æ€**ï¼š
- æ•°æ®åº“ã€è¡¨ã€å­—æ®µï¼š`utf8mb4` âœ…
- è¿æ¥å­—ç¬¦é›†ï¼š`latin1` âŒï¼ˆè¿™æ˜¯é—®é¢˜æ‰€åœ¨ï¼ï¼‰

**å½±å“**ï¼š
- æ’å…¥æ•°æ®æ—¶ï¼ŒUTF-8å­—ç¬¦ä¸²è¢«å½“ä½œlatin1å¤„ç†
- å­˜å‚¨çš„æ•°æ®ç¼–ç é”™è¯¯
- è¯»å–æ—¶å³ä½¿è®¾ç½®äº†utf8mb4ï¼Œæ•°æ®æœ¬èº«å·²ç»æŸå

---

## äºŒã€å·²å®æ–½çš„ä¿®å¤

### 1. å¢å¼ºè¿æ¥æ± å­—ç¬¦é›†è®¾ç½® âœ…

```javascript
// backend/config/database.js

// åœ¨è¿æ¥æ± åˆ›å»ºæ—¶è®¾ç½®
charset: 'utf8mb4',

// åœ¨æ¯æ¬¡è¿æ¥å»ºç«‹æ—¶ï¼Œæ˜ç¡®è®¾ç½®æ‰€æœ‰ç›¸å…³å­—ç¬¦é›†å˜é‡
pool.on('connection', async (connection) => {
  await connection.query('SET NAMES utf8mb4 COLLATE utf8mb4_unicode_ci');
  await connection.query('SET CHARACTER SET utf8mb4');
  await connection.query('SET character_set_connection = utf8mb4');
  await connection.query('SET character_set_client = utf8mb4');
  await connection.query('SET character_set_results = utf8mb4');
});
```

**ä½œç”¨**ï¼šç¡®ä¿æ¯æ¬¡ä»è¿æ¥æ± è·å–çš„è¿æ¥éƒ½ä½¿ç”¨æ­£ç¡®çš„å­—ç¬¦é›†ã€‚

---

## ä¸‰ã€ä¿®å¤å·²å­˜å‚¨çš„é”™è¯¯æ•°æ®

### æ–¹æ¡ˆ1ï¼šä½¿ç”¨MySQLçš„CONVERTå‡½æ•°ä¿®å¤

```sql
-- å°†é”™è¯¯ç¼–ç çš„æ•°æ®è½¬æ¢å›æ­£ç¡®çš„UTF-8
UPDATE insurance_products 
SET status = CONVERT(CONVERT(status USING latin1) USING utf8mb4)
WHERE product_id = 2;
```

**åŸç†**ï¼š
1. å…ˆå‘Šè¯‰MySQLï¼šè¿™ä¸ªå­—æ®µå½“å‰æ˜¯latin1ç¼–ç 
2. ç„¶åè½¬æ¢æˆutf8mb4ç¼–ç 
3. è¿™æ ·å°±èƒ½æ¢å¤æ­£ç¡®çš„å­—ç¬¦

### æ–¹æ¡ˆ2ï¼šç›´æ¥æ›´æ–°ä¸ºæ­£ç¡®å€¼

```sql
-- ç›´æ¥æ›´æ–°ä¸ºæ­£ç¡®çš„UTF-8å€¼
UPDATE insurance_products 
SET status = 'å¯ç”¨'
WHERE product_id = 2;
```

---

## å››ã€éªŒè¯ä¿®å¤

### 1. æ£€æŸ¥è¿æ¥å­—ç¬¦é›†

```sql
SHOW VARIABLES LIKE 'character%';
```

åº”è¯¥çœ‹åˆ°ï¼š
- `character_set_client`: utf8mb4
- `character_set_connection`: utf8mb4
- `character_set_results`: utf8mb4

### 2. æ£€æŸ¥æ•°æ®ç¼–ç 

```sql
SELECT 
  product_id,
  status,
  HEX(status) as status_hex
FROM insurance_products
WHERE product_id = 2;
```

æ­£ç¡®çš„HEXå€¼åº”è¯¥æ˜¯ï¼š`E590AFE794A8`ï¼ˆ"å¯ç”¨"çš„UTF-8ç¼–ç ï¼‰

### 3. æµ‹è¯•APIå“åº”

```bash
curl http://localhost:8888/api/products
```

åº”è¯¥è¿”å›æ­£ç¡®çš„UTF-8å­—ç¬¦ï¼Œæ²¡æœ‰ä¹±ç ã€‚

---

## äº”ã€é¢„é˜²æªæ–½

### 1. æ•°æ®åº“åˆå§‹åŒ–è„šæœ¬

ç¡®ä¿åœ¨åˆ›å»ºæ•°æ®åº“æ—¶æ˜ç¡®è®¾ç½®å­—ç¬¦é›†ï¼š
```sql
CREATE DATABASE IF NOT EXISTS `insurance_platform` 
DEFAULT CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
```

### 2. Docker MySQLé…ç½®

å¦‚æœä½¿ç”¨Dockerï¼Œå¯ä»¥åœ¨å¯åŠ¨æ—¶è®¾ç½®ï¼š
```bash
docker run -e MYSQL_CHARSET=utf8mb4 -e MYSQL_COLLATION=utf8mb4_unicode_ci ...
```

### 3. è¿æ¥æ± é…ç½®

å§‹ç»ˆåœ¨è¿æ¥æ± é…ç½®ä¸­æ˜ç¡®è®¾ç½® `charset: 'utf8mb4'`

### 4. æ•°æ®éªŒè¯

æ’å…¥æ•°æ®åï¼ŒéªŒè¯ç¼–ç ï¼š
```sql
SELECT HEX(column_name) FROM table_name WHERE id = ?;
```

---

## å…­ã€ä¸ºä»€ä¹ˆä¼šå‡ºç°è¿™ä¸ªé—®é¢˜ï¼Ÿ

1. **MySQLé»˜è®¤é…ç½®**ï¼šæŸäº›MySQLç‰ˆæœ¬é»˜è®¤ä½¿ç”¨ `latin1` ä½œä¸ºè¿æ¥å­—ç¬¦é›†
2. **è¿æ¥æ± å¤ç”¨**ï¼šè¿æ¥æ± å¯èƒ½å¤ç”¨äº†æœªæ­£ç¡®è®¾ç½®å­—ç¬¦é›†çš„è¿æ¥
3. **äº‹ä»¶è§¦å‘æ—¶æœº**ï¼š`pool.on('connection')` å¯èƒ½åœ¨æŸäº›æƒ…å†µä¸‹ä¸è§¦å‘
4. **æ•°æ®æ’å…¥æ—¶æœº**ï¼šå¯èƒ½åœ¨å­—ç¬¦é›†è®¾ç½®ä¹‹å‰å°±æ’å…¥äº†æ•°æ®

---

## ä¸ƒã€æœ€ä½³å®è·µæ€»ç»“

1. âœ… **æ•°æ®åº“çº§åˆ«**ï¼šåˆ›å»ºæ•°æ®åº“æ—¶æ˜ç¡®è®¾ç½® `utf8mb4`
2. âœ… **è¡¨çº§åˆ«**ï¼šåˆ›å»ºè¡¨æ—¶æ˜ç¡®è®¾ç½® `DEFAULT CHARSET=utf8mb4`
3. âœ… **è¿æ¥æ± çº§åˆ«**ï¼šåœ¨è¿æ¥æ± é…ç½®ä¸­è®¾ç½® `charset: 'utf8mb4'`
4. âœ… **è¿æ¥çº§åˆ«**ï¼šåœ¨æ¯æ¬¡è¿æ¥å»ºç«‹æ—¶è®¾ç½®å­—ç¬¦é›†å˜é‡
5. âœ… **åº”ç”¨çº§åˆ«**ï¼šHTTPå“åº”å¤´è®¾ç½® `Content-Type: application/json; charset=utf-8`

---

**ç°åœ¨è¯·é‡å¯åç«¯æœåŠ¡ï¼Œç„¶åæµ‹è¯•APIæ˜¯å¦è¿”å›æ­£ç¡®çš„UTF-8å­—ç¬¦ï¼** ğŸ”§

