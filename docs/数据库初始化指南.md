# 数据库初始化指南

## 一、MySQL安装和配置

### 方法1：使用Homebrew安装（推荐）

```bash
# 安装MySQL
brew install mysql

# 启动MySQL服务
brew services start mysql

# 设置root密码（首次安装时）
mysql_secure_installation
```

### 方法2：使用MySQL官方安装包

1. 访问：https://dev.mysql.com/downloads/mysql/
2. 下载 macOS 版本
3. 安装并配置

### 方法3：使用Docker（最简单）

```bash
# 启动MySQL容器
docker run --name mysql-insurance \
  -e MYSQL_ROOT_PASSWORD=your_password \
  -e MYSQL_DATABASE=insurance_platform \
  -p 3306:3306 \
  -d mysql:8.0

# 执行SQL脚本
docker exec -i mysql-insurance mysql -uroot -pyour_password < database_schema.sql
docker exec -i mysql-insurance mysql -uroot -pyour_password < backend/init-test-data.sql
```

---

## 二、执行SQL脚本的方法

### 方法1：使用mysql命令行（如果已安装）

```bash
# 如果mysql在PATH中
mysql -u root -p < database_schema.sql
mysql -u root -p < backend/init-test-data.sql

# 如果mysql不在PATH中，使用完整路径
/usr/local/mysql/bin/mysql -u root -p < database_schema.sql
/opt/homebrew/bin/mysql -u root -p < database_schema.sql
```

### 方法2：使用数据库管理工具

#### 使用Navicat、DBeaver、Sequel Pro等工具：

1. 连接数据库
2. 打开SQL脚本文件
3. 执行脚本

#### 使用VS Code插件：

1. 安装 "MySQL" 或 "Database Client" 插件
2. 连接数据库
3. 打开SQL文件并执行

### 方法3：使用Python脚本执行

创建一个Python脚本自动执行：

```python
# execute_sql.py
import mysql.connector
import sys

# 读取SQL文件
def execute_sql_file(filename, connection):
    with open(filename, 'r', encoding='utf-8') as f:
        sql = f.read()
        # 分割SQL语句
        statements = sql.split(';')
        cursor = connection.cursor()
        for statement in statements:
            statement = statement.strip()
            if statement:
                try:
                    cursor.execute(statement)
                except Exception as e:
                    print(f"Error executing: {statement[:50]}...")
                    print(f"Error: {e}")
        connection.commit()
        cursor.close()

# 连接数据库
conn = mysql.connector.connect(
    host='localhost',
    user='root',
    password=input('Enter MySQL root password: ')
)

# 执行SQL文件
execute_sql_file('database_schema.sql', conn)
execute_sql_file('backend/init-test-data.sql', conn)

conn.close()
print('数据库初始化完成！')
```

### 方法4：使用Node.js脚本执行

```javascript
// execute-sql.js
import mysql from 'mysql2/promise';
import fs from 'fs';
import readline from 'readline';

const rl = readline.createInterface({
  input: process.stdin,
  output: process.stdout
});

const question = (query) => new Promise(resolve => rl.question(query, resolve));

async function executeSqlFile(filename, connection) {
  const sql = fs.readFileSync(filename, 'utf-8');
  const statements = sql.split(';').filter(s => s.trim());
  
  for (const statement of statements) {
    try {
      await connection.execute(statement);
    } catch (error) {
      console.error(`Error: ${error.message}`);
    }
  }
}

async function main() {
  const password = await question('Enter MySQL root password: ');
  
  const connection = await mysql.createConnection({
    host: 'localhost',
    user: 'root',
    password: password,
    multipleStatements: true
  });
  
  console.log('执行 database_schema.sql...');
  await executeSqlFile('database_schema.sql', connection);
  
  console.log('执行 backend/init-test-data.sql...');
  await executeSqlFile('backend/init-test-data.sql', connection);
  
  await connection.end();
  rl.close();
  console.log('✅ 数据库初始化完成！');
}

main();
```

---

## 三、快速解决方案

### 方案A：使用Docker（最简单，推荐）

```bash
# 1. 安装Docker Desktop（如果还没安装）
# 下载：https://www.docker.com/products/docker-desktop

# 2. 启动MySQL容器
docker run --name mysql-insurance \
  -e MYSQL_ROOT_PASSWORD=123456 \
  -e MYSQL_DATABASE=insurance_platform \
  -p 3306:3306 \
  -d mysql:8.0

# 3. 等待几秒让MySQL启动
sleep 10

# 4. 执行SQL脚本
docker exec -i mysql-insurance mysql -uroot -p123456 insurance_platform < database_schema.sql
docker exec -i mysql-insurance mysql -uroot -p123456 insurance_platform < backend/init-test-data.sql

# 5. 验证
docker exec -i mysql-insurance mysql -uroot -p123456 insurance_platform -e "SELECT COUNT(*) FROM insurance_companies;"
```

### 方案B：安装MySQL命令行工具

```bash
# 使用Homebrew安装
brew install mysql

# 添加到PATH（如果使用zsh）
echo 'export PATH="/opt/homebrew/bin:$PATH"' >> ~/.zshrc
source ~/.zshrc

# 或者添加到PATH（如果使用bash）
echo 'export PATH="/opt/homebrew/bin:$PATH"' >> ~/.bash_profile
source ~/.bash_profile

# 然后执行SQL脚本
mysql -u root -p < database_schema.sql
```

### 方案C：使用数据库管理工具

1. **下载DBeaver**（免费）：https://dbeaver.io/download/
2. 创建MySQL连接
3. 打开SQL脚本文件并执行

---

## 四、验证数据库

### 检查数据库是否创建成功

```bash
# 如果使用Docker
docker exec -i mysql-insurance mysql -uroot -p123456 -e "SHOW DATABASES;"

# 如果使用本地MySQL
mysql -u root -p -e "SHOW DATABASES;"
```

### 检查表是否创建成功

```bash
# 如果使用Docker
docker exec -i mysql-insurance mysql -uroot -p123456 insurance_platform -e "SHOW TABLES;"

# 如果使用本地MySQL
mysql -u root -p insurance_platform -e "SHOW TABLES;"
```

### 检查测试数据

```bash
# 如果使用Docker
docker exec -i mysql-insurance mysql -uroot -p123456 insurance_platform -e "SELECT * FROM insurance_companies;"

# 如果使用本地MySQL
mysql -u root -p insurance_platform -e "SELECT * FROM insurance_companies;"
```

---

## 五、推荐方案

**推荐使用Docker方案**，因为：
1. ✅ 不需要安装MySQL到系统
2. ✅ 环境隔离，不影响系统
3. ✅ 一键启动和停止
4. ✅ 易于清理和重置

---

## 六、Docker完整操作流程

```bash
# 1. 启动MySQL容器（只需执行一次）
docker run --name mysql-insurance \
  -e MYSQL_ROOT_PASSWORD=123456 \
  -e MYSQL_DATABASE=insurance_platform \
  -p 3306:3306 \
  -d mysql:8.0

# 2. 执行SQL脚本
docker exec -i mysql-insurance mysql -uroot -p123456 insurance_platform < database_schema.sql
docker exec -i mysql-insurance mysql -uroot -p123456 insurance_platform < backend/init-test-data.sql

# 3. 验证数据
docker exec -i mysql-insurance mysql -uroot -p123456 insurance_platform -e "SELECT COUNT(*) as count FROM insurance_companies;"

# 4. 停止容器（需要时）
docker stop mysql-insurance

# 5. 启动容器（需要时）
docker start mysql-insurance

# 6. 删除容器（需要重置时）
docker rm -f mysql-insurance
```

---

## 七、后端服务配置

使用Docker时，`.env` 文件配置：

```env
DB_HOST=localhost
DB_PORT=3306
DB_USER=root
DB_PASSWORD=123456
DB_NAME=insurance_platform
```

---

## 八、常见问题

### Q: Docker命令找不到？

A: 需要安装Docker Desktop：https://www.docker.com/products/docker-desktop

### Q: 端口3306被占用？

A: 修改Docker端口映射：
```bash
docker run --name mysql-insurance \
  -e MYSQL_ROOT_PASSWORD=123456 \
  -e MYSQL_DATABASE=insurance_platform \
  -p 3307:3306 \  # 改为3307端口
  -d mysql:8.0
```

然后修改 `.env` 文件中的 `DB_PORT=3307`

### Q: 忘记root密码？

A: 重置Docker容器：
```bash
docker rm -f mysql-insurance
# 重新创建容器
```

