# 测试验证指南

## 一、准备工作

### 1.1 创建数据库

```bash
# 执行SQL脚本创建数据库
mysql -u root -p < database_schema.sql
```

### 1.2 准备测试数据

需要先插入一些测试数据：

```sql
-- 1. 插入保司
INSERT INTO insurance_companies (company_code, company_name, status) 
VALUES ('LIBO', '利宝保险', '启用');

-- 2. 插入保司责任
INSERT INTO company_liabilities (company_id, liability_code, liability_name, liability_type, unit_type, status)
SELECT company_id, 'DEATH_BENEFIT', '意外身故伤残保险金', '身故', '金额', '启用'
FROM insurance_companies WHERE company_code = 'LIBO';

INSERT INTO company_liabilities (company_id, liability_code, liability_name, liability_type, unit_type, status)
SELECT company_id, 'MEDICAL_BENEFIT', '医疗费用保险金', '医疗', '金额', '启用'
FROM insurance_companies WHERE company_code = 'LIBO';

INSERT INTO company_liabilities (company_id, liability_code, liability_name, liability_type, unit_type, status)
SELECT company_id, 'DAILY_HOSPITAL', '意外每日住院津贴', '津贴', '天数', '启用'
FROM insurance_companies WHERE company_code = 'LIBO';

-- 3. 插入产品
INSERT INTO insurance_products (company_id, product_code, product_name, product_type, status)
SELECT company_id, 'PRODUCT_A', '雇主责任险A', '雇主责任险', '启用'
FROM insurance_companies WHERE company_code = 'LIBO';

-- 4. 插入方案
INSERT INTO product_plans (product_id, plan_code, plan_name, job_class_range, duration_options, payment_type, status)
SELECT product_id, 'PLAN_01', '方案一', '1~3类', '["1年","6个月"]', '一次交清', '启用'
FROM insurance_products WHERE product_code = 'PRODUCT_A';

-- 5. 插入方案责任配置
INSERT INTO plan_liabilities (plan_id, liability_id, is_required, coverage_options, default_coverage, unit, display_order, status)
SELECT 
  p.plan_id,
  cl.liability_id,
  TRUE,
  CASE 
    WHEN cl.liability_code = 'DEATH_BENEFIT' THEN '["10万","30万","50万","80万","100万"]'
    WHEN cl.liability_code = 'MEDICAL_BENEFIT' THEN '["1万","2万","5万"]'
    WHEN cl.liability_code = 'DAILY_HOSPITAL' THEN '["100元/天"]'
  END,
  CASE 
    WHEN cl.liability_code = 'DEATH_BENEFIT' THEN '10万'
    WHEN cl.liability_code = 'MEDICAL_BENEFIT' THEN '1万'
    WHEN cl.liability_code = 'DAILY_HOSPITAL' THEN '100元/天'
  END,
  CASE 
    WHEN cl.liability_code = 'DAILY_HOSPITAL' THEN '元/天'
    ELSE '元'
  END,
  CASE 
    WHEN cl.liability_code = 'DEATH_BENEFIT' THEN 1
    WHEN cl.liability_code = 'MEDICAL_BENEFIT' THEN 2
    WHEN cl.liability_code = 'DAILY_HOSPITAL' THEN 3
  END,
  '启用'
FROM product_plans p
CROSS JOIN company_liabilities cl
WHERE p.plan_code = 'PLAN_01'
  AND cl.company_id = (SELECT company_id FROM insurance_companies WHERE company_code = 'LIBO');

-- 6. 插入费率配置
INSERT INTO premium_rates (product_id, liability_id, job_class, coverage_amount, base_rate, rate_factor, effective_date, status)
SELECT 
  pr.product_id,
  cl.liability_id,
  '1~3类',
  '10万',
  0.0081,
  1.0,
  CURDATE(),
  '启用'
FROM insurance_products pr
CROSS JOIN company_liabilities cl
WHERE pr.product_code = 'PRODUCT_A'
  AND cl.liability_code = 'DEATH_BENEFIT'
  AND cl.company_id = pr.company_id;

INSERT INTO premium_rates (product_id, liability_id, job_class, coverage_amount, base_rate, rate_factor, effective_date, status)
SELECT 
  pr.product_id,
  cl.liability_id,
  '1~3类',
  '30万',
  0.0146,
  1.0,
  CURDATE(),
  '启用'
FROM insurance_products pr
CROSS JOIN company_liabilities cl
WHERE pr.product_code = 'PRODUCT_A'
  AND cl.liability_code = 'DEATH_BENEFIT'
  AND cl.company_id = pr.company_id;
```

---

## 二、后端API测试

### 2.1 启动后端服务

```bash
cd backend
npm install
npm run dev
```

### 2.2 运行自动化测试

```bash
npm test
```

### 2.3 手动测试各个接口

#### 测试1：健康检查
```bash
curl http://localhost:3000/health
```

**预期结果**：
```json
{"status":"ok","timestamp":"2025-01-01T10:00:00.000Z"}
```

#### 测试2：获取保司列表
```bash
curl http://localhost:3000/api/insurance-companies
```

**预期结果**：
```json
{
  "success": true,
  "data": [
    {
      "company_id": 1,
      "company_code": "LIBO",
      "company_name": "利宝保险"
    }
  ],
  "count": 1
}
```

#### 测试3：获取产品列表
```bash
curl http://localhost:3000/api/products
```

**预期结果**：返回产品列表

#### 测试4：获取方案列表
```bash
curl http://localhost:3000/api/products/1/plans
```

**预期结果**：返回方案列表

#### 测试5：获取方案责任配置
```bash
curl http://localhost:3000/api/plans/1/liabilities
```

**预期结果**：返回责任配置，包含保额选项

#### 测试6：计算保费
```bash
curl -X POST http://localhost:3000/api/premium/calculate \
  -H "Content-Type: application/json" \
  -d '{
    "product_id": 1,
    "plan_id": 1,
    "liability_selections": [
      {"liability_id": 1, "coverage_amount": "10万"}
    ],
    "job_class": "1~3类",
    "insured_count": 10
  }'
```

**预期结果**：返回计算后的保费

#### 测试7：创建投保单
```bash
curl -X POST http://localhost:3000/api/applications \
  -H "Content-Type: application/json" \
  -d '{
    "company_info": {
      "name": "测试企业",
      "credit_code": "TEST001",
      "province": "北京市",
      "city": "北京市",
      "district": "通州区",
      "address": "测试地址",
      "contact_name": "张三",
      "contact_phone": "13800138000",
      "contact_email": "test@example.com"
    },
    "product_id": 1,
    "plan_instances": [
      {
        "plan_id": 1,
        "plan_name": "方案一",
        "job_class": "1~3类",
        "duration": "1年",
        "insured_count": 10,
        "liability_selections": [
          {
            "liability_id": 1,
            "coverage_amount": "10万",
            "unit": "元"
          }
        ]
      }
    ],
    "effective_date": "2025-01-01",
    "expiry_date": "2026-01-01"
  }'
```

**预期结果**：返回投保单ID和投保单号

---

## 三、前端集成测试

### 3.1 配置环境变量

在项目根目录创建 `.env.local`：

```env
VITE_API_BASE_URL=http://localhost:3000/api
```

### 3.2 修改前端代码

在 `pages/NewPolicy.tsx` 中，使用动态组件：

```typescript
import PlanSelectionDynamic from '../src/components/PlanSelectionDynamic';

// 替换 PlanSelection 组件
{currentStep === 1 && (
  <PlanSelectionDynamic
    plans={plans}
    setPlans={setPlans}
    companyInfo={companyInfo}
    setCompanyInfo={setCompanyInfo}
    onNext={() => setCurrentStep(2)}
  />
)}
```

### 3.3 测试前端功能

1. **启动前端**：`npm run dev`
2. **访问投保页面**：`http://localhost:3000/new-policy`
3. **测试流程**：
   - ✅ 选择产品（应该显示从后台获取的产品列表）
   - ✅ 选择方案（应该显示从后台获取的方案列表）
   - ✅ 选择责任和保额（应该显示从后台获取的保额选项）
   - ✅ 查看保费（应该显示从后台计算出的保费）
   - ✅ 提交投保（应该成功创建投保单）

---

## 四、数据库验证

### 4.1 验证数据是否正确保存

```sql
-- 查看投保单
SELECT * FROM applications ORDER BY created_at DESC LIMIT 1;

-- 查看方案实例
SELECT * FROM application_plans WHERE application_id = ?;

-- 查看责任选择
SELECT * FROM plan_instance_liabilities WHERE instance_id = ?;
```

### 4.2 验证数据一致性

- 投保单的 `product_id` 应该对应 `insurance_products` 表
- 方案实例的 `plan_id` 应该对应 `product_plans` 表
- 责任选择的 `liability_id` 应该对应 `company_liabilities` 表

---

## 五、测试检查清单

### 5.1 后端API测试

- [ ] 健康检查接口正常
- [ ] 获取保司列表正常
- [ ] 获取产品列表正常
- [ ] 获取方案列表正常
- [ ] 获取方案责任配置正常
- [ ] 计算保费正常
- [ ] 创建投保单正常
- [ ] 错误处理正常

### 5.2 前端集成测试

- [ ] 产品选择正常（从API获取）
- [ ] 方案选择正常（从API获取）
- [ ] 责任配置正常（从API获取）
- [ ] 保费计算正常（调用API）
- [ ] 提交投保正常（数据保存到数据库）

### 5.3 数据一致性测试

- [ ] 前端显示的数据与后台配置一致
- [ ] 提交的数据结构与数据库设计一致
- [ ] 数据保存完整（投保单、方案实例、责任选择都保存）

---

## 六、常见问题

### 6.1 数据库连接失败

**问题**：`数据库连接失败`

**解决**：
1. 检查 `.env` 文件配置
2. 确保数据库已创建
3. 检查数据库用户权限

### 6.2 API返回404

**问题**：`接口不存在`

**解决**：
1. 检查API路径是否正确
2. 检查服务器是否启动
3. 检查路由配置

### 6.3 前端无法获取数据

**问题**：前端调用API失败

**解决**：
1. 检查 `VITE_API_BASE_URL` 配置
2. 检查CORS配置
3. 检查浏览器控制台错误信息

---

## 七、测试报告模板

```
测试日期：2025-01-01
测试人员：XXX

后端API测试：
✅ 健康检查 - 通过
✅ 获取保司列表 - 通过
✅ 获取产品列表 - 通过
✅ 获取方案列表 - 通过
✅ 获取方案责任配置 - 通过
✅ 计算保费 - 通过
✅ 创建投保单 - 通过

前端集成测试：
✅ 产品选择 - 通过
✅ 方案选择 - 通过
✅ 责任配置 - 通过
✅ 保费计算 - 通过
✅ 提交投保 - 通过

数据一致性测试：
✅ 数据保存完整 - 通过
✅ 数据结构正确 - 通过

问题记录：
无

测试结论：
所有功能测试通过，可以投入使用。
```

