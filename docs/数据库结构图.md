# 数据库结构图

## 一、核心业务表关系图

```mermaid
erDiagram
    %% 企业相关
    companies ||--o{ applications : "一个企业可以有多个投保单"
    companies ||--o{ policies : "一个企业可以有多个保单"
    
    %% 产品相关
    insurance_products ||--o{ product_liabilities : "一个产品可以有多个责任"
    insurance_products ||--o{ product_plan_templates : "一个产品可以有多个方案模板"
    insurance_products ||--o{ premium_rates : "一个产品可以有多个费率"
    insurance_products ||--o{ applications : "一个产品可以有多个投保单"
    
    %% 责任相关
    insurance_liabilities ||--o{ product_liabilities : "一个责任可以关联多个产品"
    insurance_liabilities ||--o{ plan_liabilities : "一个责任可以关联多个方案"
    insurance_liabilities ||--o{ premium_rates : "一个责任可以有多个费率"
    
    %% 方案相关
    insurance_plans ||--o{ plan_liabilities : "一个方案可以有多个责任"
    insurance_plans ||--o{ application_plans : "一个方案可以关联多个投保单"
    insurance_plans ||--o{ insured_persons : "一个方案可以有多个被保人"
    
    %% 投保单相关
    applications ||--o{ application_plans : "一个投保单可以有多个方案"
    applications ||--o{ insured_persons : "一个投保单可以有多个被保人"
    applications ||--|| policies : "一个投保单对应一个保单"
    
    %% 保单相关
    policies ||--o{ endorsements : "一个保单可以有多个批改"
    policies ||--o{ renewals : "一个保单可以有多个续保"
    policies ||--o{ invoices : "一个保单可以有多个发票"
    policies ||--o{ receipts : "一个保单可以有多个回执"
    
    %% 批改相关
    endorsements ||--o{ endorsement_persons : "一个批改可以有多个被保人操作"
    
    %% 续保相关
    renewals }o--|| policies : "续保关联原保单"
    renewals }o--o| policies : "续保生成新保单"
    
    %% 表定义
    companies {
        BIGINT company_id PK
        VARCHAR company_name
        VARCHAR credit_code
        VARCHAR province
        VARCHAR city
        VARCHAR district
        VARCHAR address
        VARCHAR contact_name
        VARCHAR contact_phone
        VARCHAR contact_email
    }
    
    insurance_products {
        BIGINT product_id PK
        VARCHAR insurance_company_code
        VARCHAR product_code
        VARCHAR product_name
        VARCHAR registration_no
    }
    
    insurance_liabilities {
        BIGINT liability_id PK
        VARCHAR liability_code
        VARCHAR liability_name
        VARCHAR liability_type
        VARCHAR unit_type
    }
    
    product_liabilities {
        BIGINT id PK
        BIGINT product_id FK
        BIGINT liability_id FK
        BOOLEAN is_required
        TEXT coverage_options
        VARCHAR default_coverage
    }
    
    product_plan_templates {
        BIGINT template_id PK
        BIGINT product_id FK
        VARCHAR template_code
        VARCHAR template_name
        VARCHAR job_class_range
        TEXT duration_options
    }
    
    insurance_plans {
        BIGINT plan_id PK
        VARCHAR plan_name
        VARCHAR job_class
        VARCHAR duration
        VARCHAR payment_type
        DECIMAL base_premium
    }
    
    plan_liabilities {
        BIGINT id PK
        BIGINT plan_id FK
        BIGINT liability_id FK
        VARCHAR coverage_amount
        DECIMAL coverage_value
        VARCHAR unit
    }
    
    applications {
        BIGINT application_id PK
        VARCHAR application_no
        BIGINT company_id FK
        VARCHAR product_code
        DECIMAL total_premium
        INT insured_count
        DATE effective_date
        DATE expiry_date
        VARCHAR status
    }
    
    application_plans {
        BIGINT id PK
        BIGINT application_id FK
        BIGINT plan_id FK
        INT insured_count
        DECIMAL plan_premium
    }
    
    insured_persons {
        BIGINT person_id PK
        BIGINT application_id FK
        BIGINT plan_id FK
        VARCHAR name
        VARCHAR id_type
        VARCHAR id_number
        VARCHAR gender
        DATE birth_date
        VARCHAR job_code
        VARCHAR job_category
        DECIMAL individual_premium
    }
    
    policies {
        BIGINT policy_id PK
        VARCHAR policy_no
        BIGINT application_id FK
        BIGINT company_id FK
        VARCHAR product_code
        DECIMAL total_premium
        INT insured_count
        DATE effective_date
        DATE expiry_date
        VARCHAR status
    }
    
    endorsements {
        BIGINT endorsement_id PK
        VARCHAR endorsement_no
        BIGINT policy_id FK
        VARCHAR endorsement_type
        INT add_count
        INT remove_count
        DECIMAL premium_change
        VARCHAR status
    }
    
    endorsement_persons {
        BIGINT id PK
        BIGINT endorsement_id FK
        VARCHAR operation_type
        BIGINT old_person_id
        BIGINT new_person_id
    }
    
    renewals {
        BIGINT renewal_id PK
        VARCHAR renewal_no
        BIGINT original_policy_id FK
        BIGINT new_policy_id FK
        BIGINT company_id FK
        DECIMAL renewal_premium
        VARCHAR status
    }
    
    invoices {
        BIGINT invoice_id PK
        VARCHAR invoice_no
        BIGINT policy_id FK
        BIGINT company_id FK
        VARCHAR invoice_type
        DECIMAL invoice_amount
        VARCHAR status
    }
    
    receipts {
        BIGINT receipt_id PK
        VARCHAR receipt_no
        BIGINT policy_id FK
        BIGINT company_id FK
        VARCHAR receipt_type
        VARCHAR signer_name
        DATETIME signed_at
        VARCHAR status
    }
```

## 二、接口对接相关表关系图

```mermaid
erDiagram
    %% 渠道相关
    channels ||--o{ api_field_mappings : "一个渠道可以有多个字段映射"
    channels ||--o{ underwriting_intercept_rules : "一个渠道可以有多个拦截规则"
    channels ||--o{ insurance_api_tasks : "一个渠道可以有多个任务"
    channels ||--o{ insurance_api_logs : "一个渠道可以有多个日志"
    
    %% 产品相关
    insurance_products ||--o{ channels : "一个产品可以通过多个渠道对接"
    
    %% 接口任务相关
    insurance_api_tasks }o--|| applications : "任务关联投保单"
    insurance_api_tasks }o--|| policies : "任务关联保单"
    insurance_api_tasks }o--|| endorsements : "任务关联批改"
    
    %% 表定义
    channels {
        BIGINT channel_id PK
        VARCHAR channel_code
        VARCHAR channel_name
        VARCHAR insurance_company_code
        VARCHAR api_base_url
        VARCHAR api_version
        VARCHAR app_id
        VARCHAR app_secret
    }
    
    api_field_mappings {
        BIGINT mapping_id PK
        BIGINT channel_id FK
        VARCHAR api_name
        VARCHAR system_field
        VARCHAR api_field
        VARCHAR field_type
        TEXT format_rule
    }
    
    underwriting_intercept_rules {
        BIGINT rule_id PK
        BIGINT channel_id FK
        VARCHAR rule_name
        VARCHAR rule_type
        VARCHAR check_field
        VARCHAR check_operator
        VARCHAR check_value
        VARCHAR error_code
        INT priority
    }
    
    data_validation_rules {
        BIGINT validation_id PK
        VARCHAR field_name
        VARCHAR field_type
        VARCHAR validation_type
        TEXT validation_rule
        VARCHAR error_message
    }
    
    insurance_api_tasks {
        BIGINT task_id PK
        VARCHAR task_type
        VARCHAR insurance_company
        VARCHAR business_id
        TEXT request_data
        TEXT response_data
        VARCHAR status
        INT retry_count
    }
    
    insurance_api_logs {
        BIGINT log_id PK
        VARCHAR insurance_company
        VARCHAR api_name
        VARCHAR api_url
        TEXT request_body
        TEXT response_body
        INT response_status
        VARCHAR business_id
        DATETIME created_at
    }
```

## 三、系统管理表关系图

```mermaid
erDiagram
    users ||--o{ operation_logs : "一个用户可以有多个操作日志"
    
    users {
        BIGINT user_id PK
        VARCHAR username
        VARCHAR password_hash
        VARCHAR phone
        VARCHAR email
        VARCHAR role
        VARCHAR status
    }
    
    operation_logs {
        BIGINT log_id PK
        BIGINT user_id FK
        VARCHAR operation_type
        VARCHAR business_id
        VARCHAR operation_desc
        VARCHAR ip_address
        DATETIME created_at
    }
```

## 四、完整数据库表清单

### 4.1 核心业务表（14张）

1. **companies** - 投保企业表
2. **insurance_products** - 保司产品表
3. **insurance_liabilities** - 保险责任表
4. **product_liabilities** - 产品责任关联表
5. **product_plan_templates** - 产品方案模板表
6. **insurance_plans** - 投保方案表
7. **plan_liabilities** - 方案责任关联表
8. **applications** - 投保单表
9. **application_plans** - 投保单方案关联表
10. **insured_persons** - 被保人表
11. **policies** - 保单表
12. **endorsements** - 批改申请表
13. **endorsement_persons** - 批改被保人明细表
14. **renewals** - 续保申请表
15. **invoices** - 发票申请表
16. **receipts** - 回执表

### 4.2 接口对接表（7张）

1. **channels** - 渠道配置表
2. **api_field_mappings** - 接口字段映射表
3. **underwriting_intercept_rules** - 承保拦截规则表
4. **data_validation_rules** - 数据校验规则表
5. **insurance_api_tasks** - 保司接口任务表
6. **insurance_api_logs** - 保司接口调用日志表
7. **insurance_api_configs** - 保司接口配置表

### 4.3 配置管理表（3张）

1. **premium_rates** - 费率配置表
2. **insurance_api_configs** - 保司接口配置表（与接口对接表重复）

### 4.4 系统管理表（2张）

1. **users** - 用户表
2. **operation_logs** - 操作日志表

**总计：约28张表**

## 五、核心业务流程表关系

### 5.1 投保流程

```
companies (企业)
    ↓
applications (投保单)
    ↓
application_plans (投保单方案关联)
    ↓
insurance_plans (方案)
    ↓
plan_liabilities (方案责任关联)
    ↓
insurance_liabilities (责任)
    ↓
insured_persons (被保人)
```

### 5.2 产品配置流程

```
insurance_products (产品)
    ↓
product_liabilities (产品责任关联)
    ↓
insurance_liabilities (责任)
    ↓
product_plan_templates (方案模板)
    ↓
premium_rates (费率配置)
```

### 5.3 承保流程

```
applications (投保单)
    ↓
underwriting_intercept_rules (拦截规则检查)
    ↓
api_field_mappings (字段映射)
    ↓
channels (渠道配置)
    ↓
insurance_api_tasks (接口任务)
    ↓
insurance_api_logs (接口日志)
    ↓
policies (保单)
```

## 六、表关系说明

### 6.1 一对多关系

- 一个企业 → 多个投保单
- 一个企业 → 多个保单
- 一个产品 → 多个责任（通过 product_liabilities）
- 一个产品 → 多个方案模板
- 一个产品 → 多个费率配置
- 一个投保单 → 多个方案（通过 application_plans）
- 一个投保单 → 多个被保人
- 一个方案 → 多个责任（通过 plan_liabilities）
- 一个方案 → 多个被保人
- 一个保单 → 多个批改
- 一个保单 → 多个续保
- 一个保单 → 多个发票
- 一个保单 → 多个回执
- 一个渠道 → 多个字段映射
- 一个渠道 → 多个拦截规则

### 6.2 多对多关系

- 产品 ↔ 责任（通过 product_liabilities）
- 方案 ↔ 责任（通过 plan_liabilities）
- 投保单 ↔ 方案（通过 application_plans）

### 6.3 一对一关系

- 投保单 ↔ 保单（一个投保单对应一个保单）

## 七、关键索引建议

### 7.1 唯一索引

- `companies.credit_code` - 统一社会信用代码
- `applications.application_no` - 投保单号
- `policies.policy_no` - 保单号
- `insurance_liabilities.liability_code` - 责任代码
- `channels.channel_code` - 渠道代码

### 7.2 外键索引

- `applications.company_id`
- `applications.product_code`
- `policies.company_id`
- `policies.application_id`
- `product_liabilities.product_id`
- `product_liabilities.liability_id`
- `plan_liabilities.plan_id`
- `plan_liabilities.liability_id`
- `insured_persons.application_id`
- `insured_persons.plan_id`

### 7.3 查询索引

- `applications.status`
- `policies.status`
- `insurance_api_logs.business_id`
- `insurance_api_logs.created_at`
- `underwriting_intercept_rules.status`
- `underwriting_intercept_rules.priority`
- `premium_rates.job_class`

