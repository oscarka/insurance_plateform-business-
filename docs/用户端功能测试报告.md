# 用户端功能测试报告

## 测试时间
2025-12-10

## 测试范围
- 方案选择和展示
- 保费计算功能
- 下载模版功能

---

## 一、方案选择和展示测试

### ✅ 1. 方案列表获取
- **功能位置**：`src/components/PlanSelectionDynamic.tsx`
- **API调用**：`getPlans(productId)`
- **实现状态**：✅ 已实现
- **代码位置**：
  ```typescript
  useEffect(() => {
    if (selectedProductId) {
      fetchPlans(selectedProductId);
    }
  }, [selectedProductId]);
  ```

### ✅ 2. 方案展示
- **显示方式**：下拉选择框
- **显示内容**：方案名称（plan_name）
- **实现状态**：✅ 已实现
- **代码位置**：
  ```typescript
  <select value={planId || ''} onChange={(e) => handleSelectPlan(plan.id, Number(e.target.value))}>
    <option value="">请选择方案</option>
    {availablePlans.map((p) => (
      <option key={p.plan_id} value={p.plan_id}>
        {p.plan_name}
      </option>
    ))}
  </select>
  ```

### ✅ 3. 方案责任配置展示
- **功能**：选择方案后，自动加载方案的责任配置
- **API调用**：`getPlanLiabilities(planId)`
- **显示内容**：责任名称、保额选项
- **实现状态**：✅ 已实现

### 📝 测试建议
1. **启动后端服务**：确保后端服务运行在`http://localhost:8888`
2. **测试步骤**：
   - 打开用户端页面
   - 选择产品
   - 查看方案列表是否正确显示
   - 选择方案，查看责任配置是否正确加载

---

## 二、保费计算功能测试

### ✅ 1. 保费计算API调用
- **功能位置**：`src/components/PlanSelectionDynamic.tsx`
- **API调用**：`calculatePremium(params)`
- **实现状态**：✅ 已实现
- **调用时机**：
  - 方案配置变化时自动计算
  - 投保人数变化时自动计算
  - 责任选择变化时自动计算

### ✅ 2. 保费计算逻辑
- **支持模式**：
  1. **固定保费模式**：当`premium_type='固定保费'`时，直接使用`monthly_premium`或`annual_premium`
  2. **费率计算模式**：根据责任、职业类别、保额等计算
- **参数传递**：
  ```typescript
  {
    product_id: selectedProductId,
    plan_id: planId,
    liability_selections: liabilitySelections,
    job_class: plan.jobClass,
    insured_count: plan.insuredCount,
    duration: plan.duration || '1年'
  }
  ```

### ✅ 3. 保费显示
- **显示位置**：方案配置区域
- **显示格式**：`¥{premium}元`
- **实现状态**：✅ 已实现

### 📝 测试建议
1. **测试固定保费**：
   - 选择方案一（28元/人/月）
   - 设置投保人数为10人
   - 选择保障时间为"1年"
   - 验证保费显示：336元/人/年 × 10人 = 3360元

2. **测试费率计算**：
   - 选择方案（如果有费率计算模式）
   - 选择不同职业类别
   - 选择不同保额
   - 验证保费是否正确计算

---

## 三、下载模版功能测试

### ✅ 1. 下载按钮
- **功能位置**：`pages/NewPolicy.tsx` - `InfoFilling`组件
- **按钮位置**：第二步"被保人信息"区域
- **实现状态**：✅ 已实现UI，✅ 已实现功能

### ✅ 2. 模版内容
- **文件格式**：CSV（可扩展为Excel）
- **包含字段**：
  1. 姓名
  2. 证件类型
  3. 证件号码
  4. 性别
  5. 出生日期
  6. 职业代码
  7. 职业类别
  8. 是否涉及高处作业 ✅（新增）
  9. 职务/工种描述 ✅（任务32要求）
  10. 国籍 ✅（任务32要求）
  11. 月工资币别 ✅（任务32要求）
  12. 月工资金额 ✅（任务32要求）
  13. 赔偿月数 ✅（任务32要求）
  14. 用工单位 ✅（任务32要求）
  15. 用工地点 ✅（任务32要求）
  16. 是否参保工伤保险 ✅（任务32要求）
  17. 备注 ✅（任务32要求）

### ✅ 3. 实现代码
```typescript
const handleDownloadTemplate = () => {
  const templateData = [
    ['姓名', '证件类型', '证件号码', '性别', '出生日期', '职业代码', '职业类别', '是否涉及高处作业', '职务/工种描述', '国籍', '月工资币别', '月工资金额', '赔偿月数', '用工单位', '用工地点', '是否参保工伤保险', '备注']
  ];
  
  const csvContent = templateData.map(row => row.join(',')).join('\n');
  const blob = new Blob(['\ufeff' + csvContent], { type: 'text/csv;charset=utf-8;' });
  const link = document.createElement('a');
  const url = URL.createObjectURL(blob);
  link.setAttribute('href', url);
  link.setAttribute('download', '人员清单导入模版.csv');
  link.style.visibility = 'hidden';
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
};
```

### 📝 测试建议
1. **测试步骤**：
   - 打开用户端页面
   - 进入第二步"填写投保信息"
   - 点击"下载投保模版"按钮
   - 验证文件是否下载
   - 打开文件，验证字段是否完整

---

## 四、功能测试结果

### ✅ 已完成功能
1. ✅ **方案选择和展示**：已实现，从API获取方案列表并展示
2. ✅ **保费计算**：已实现，支持固定保费和费率计算两种模式
3. ✅ **下载模版**：已实现，包含所有必需字段（包括任务32要求的字段）

### ⏳ 待测试项
1. ⏳ **浏览器实际测试**：需要在浏览器中实际测试所有功能
2. ⏳ **端到端测试**：测试完整的投保流程
3. ⏳ **错误处理测试**：测试各种错误场景（API失败、数据异常等）

---

## 五、API测试结果

### 后端服务状态
- ⚠️ **后端服务未运行**：需要启动后端服务才能进行API测试

### 预期API响应

#### 1. 方案列表API
```json
{
  "success": true,
  "data": [
    {
      "plan_id": 1,
      "plan_name": "方案一",
      "duration_options": ["1年", "1个月"]
    },
    {
      "plan_id": 2,
      "plan_name": "方案二",
      "duration_options": ["1年", "1个月"]
    }
  ]
}
```

#### 2. 保费计算API（固定保费）
```json
{
  "success": true,
  "data": {
    "premium_per_person": 336,
    "total_premium": 3360,
    "insured_count": 10,
    "premium_type": "固定保费"
  }
}
```

#### 3. 方案责任配置API
```json
{
  "success": true,
  "data": [
    {
      "liability_id": 1,
      "liability_name": "死亡/伤残",
      "coverage_options": ["10万", "30万", "50万", "80万", "100万"]
    }
  ]
}
```

---

## 六、测试建议

### 1. 启动后端服务
```bash
cd backend
npm run dev
```

### 2. 启动前端服务
```bash
npm run dev
```

### 3. 浏览器测试步骤
1. 打开用户端页面（http://localhost:5173）
2. 进入"新保单"页面
3. 测试方案选择：
   - 选择产品
   - 查看方案列表
   - 选择方案
   - 查看责任配置
4. 测试保费计算：
   - 设置投保人数
   - 选择保障时间
   - 查看保费是否正确计算
5. 测试下载模版：
   - 进入第二步
   - 点击"下载投保模版"
   - 验证文件下载和内容

---

## 七、已知问题

### 1. 保费计算错误处理
- **问题**：当API调用失败时，只打印错误到控制台
- **改进**：已添加alert提示用户

### 2. 下载模版格式
- **当前**：CSV格式
- **建议**：可以升级为Excel格式（项目已安装xlsx库）

---

## 八、总结

**所有核心功能已实现**：
- ✅ 方案选择和展示
- ✅ 保费计算（支持固定保费和费率计算）
- ✅ 下载模版（包含所有必需字段）

**建议进行浏览器实际测试以验证用户体验。**
