# 系统启动指南

## 一、系统组成

系统由三部分组成：

1. **用户端**（企业客户使用）- 端口 3000
2. **后台管理系统**（内部管理）- 端口 3001
3. **后端API服务**（业务处理）- 端口 3000（与用户端不同进程）

---

## 二、启动步骤

### 步骤1：启动数据库（如果还没启动）

```bash
# 使用Docker启动MySQL
docker start mysql-insurance

# 或者使用启动脚本
./使用Docker启动数据库.sh
```

**验证数据库**：
```bash
docker ps | grep mysql-insurance
```

---

### 步骤2：启动后端API服务

```bash
# 进入后端目录
cd backend

# 检查.env文件是否存在
cat .env

# 如果不存在，创建.env文件
cat > .env << 'EOF'
DB_HOST=localhost
DB_PORT=3306
DB_USER=root
DB_PASSWORD=123456
DB_NAME=insurance_platform
PORT=3000
NODE_ENV=development
EOF

# 启动后端服务
npm run dev
```

**验证后端服务**：
- 打开浏览器访问：http://localhost:3000/health
- 应该看到：`{"status":"ok","timestamp":"..."}`

**或者测试API**：
```bash
curl http://localhost:3000/api/products
```

---

### 步骤3：启动用户端（新终端）

```bash
# 在项目根目录
cd /Users/cc/insuranceplateform

# 启动用户端
npm run dev
```

**访问地址**：http://localhost:3000

**注意**：如果端口冲突，Vite会自动使用其他端口（如3001），注意看终端输出

---

### 步骤4：启动后台管理系统（新终端）

```bash
# 进入后台管理目录
cd admin

# 启动后台管理系统
npm run dev
```

**访问地址**：http://localhost:3001/admin

**登录**：目前是模拟登录，任意用户名密码都可以

---

## 三、系统关联关系

### 3.1 数据流向

```
用户端 (3000) ──┐
                ├──> 后端API (3000) ──> 数据库 (MySQL)
后台管理 (3001) ─┘
```

### 3.2 关联说明

1. **用户端 ↔ 后端API**
   - 用户端调用后端API获取产品、方案、责任配置
   - 用户端提交投保单到后端API
   - API地址：`http://localhost:3000/api`

2. **后台管理 ↔ 后端API**
   - 后台管理调用后端API管理产品、方案、费率等
   - 后台管理配置的数据，用户端可以实时看到
   - API地址：`http://localhost:3000/api`

3. **后端API ↔ 数据库**
   - 后端API连接MySQL数据库
   - 所有数据都存储在数据库中

---

## 四、验证关联

### 4.1 验证用户端和后台的关联

**步骤**：

1. **在后台管理系统配置产品**
   - 访问：http://localhost:3001/admin
   - 进入"产品管理"
   - 添加或查看产品

2. **在用户端查看产品**
   - 访问：http://localhost:3000/new-policy
   - 应该能看到后台配置的产品

**注意**：目前用户端可能还在使用Mock数据，需要检查代码

---

### 4.2 验证数据流

**测试流程**：

1. **后台配置产品**
   ```
   后台管理 → 产品管理 → 添加产品
   ```

2. **后端API返回产品**
   ```
   访问：http://localhost:3000/api/products
   应该能看到后台配置的产品
   ```

3. **用户端显示产品**
   ```
   用户端 → 调用API → 显示产品列表
   ```

---

## 五、常见问题

### 问题1：端口冲突

**现象**：启动失败，提示端口被占用

**解决**：
```bash
# 查看端口占用
lsof -i :3000
lsof -i :3001

# 杀死占用进程
kill -9 <PID>
```

或者修改端口：
- 用户端：修改 `vite.config.ts` 中的 `server.port`
- 后台管理：修改 `admin/vite.config.ts` 中的 `server.port`
- 后端API：修改 `backend/.env` 中的 `PORT`

---

### 问题2：数据库连接失败

**现象**：后端服务启动失败，提示数据库连接失败

**解决**：
1. 检查数据库是否启动：`docker ps | grep mysql-insurance`
2. 检查.env配置是否正确
3. 测试数据库连接：
   ```bash
   docker exec -i mysql-insurance mysql -uroot -p123456 -e "SELECT 1;"
   ```

---

### 问题3：用户端看不到后台配置的数据

**原因**：用户端可能还在使用Mock数据

**解决**：
1. 检查 `src/services/api.ts` 是否连接了后端API
2. 检查 `pages/NewPolicy.tsx` 是否使用了动态组件
3. 查看浏览器控制台，看API调用是否成功

---

## 六、快速启动脚本

创建 `start-all.sh` 脚本：

```bash
#!/bin/bash

echo "🚀 启动所有服务..."

# 启动数据库
echo "1. 启动数据库..."
docker start mysql-insurance 2>/dev/null || echo "数据库已启动或不存在"

# 启动后端API
echo "2. 启动后端API..."
cd backend
npm run dev > /tmp/backend.log 2>&1 &
BACKEND_PID=$!
cd ..
echo "后端API已启动 (PID: $BACKEND_PID)"

# 等待后端启动
sleep 3

# 启动用户端
echo "3. 启动用户端..."
npm run dev > /tmp/frontend.log 2>&1 &
FRONTEND_PID=$!
echo "用户端已启动 (PID: $FRONTEND_PID)"

# 启动后台管理
echo "4. 启动后台管理..."
cd admin
npm run dev > /tmp/admin.log 2>&1 &
ADMIN_PID=$!
cd ..
echo "后台管理已启动 (PID: $ADMIN_PID)"

echo ""
echo "✅ 所有服务已启动！"
echo ""
echo "访问地址："
echo "  用户端：http://localhost:3000"
echo "  后台管理：http://localhost:3001/admin"
echo "  后端API：http://localhost:3000/api"
echo ""
echo "查看日志："
echo "  后端：tail -f /tmp/backend.log"
echo "  用户端：tail -f /tmp/frontend.log"
echo "  后台管理：tail -f /tmp/admin.log"
echo ""
echo "停止服务："
echo "  kill $BACKEND_PID $FRONTEND_PID $ADMIN_PID"
```

---

## 七、启动检查清单

- [ ] 数据库已启动（Docker MySQL）
- [ ] 后端API已启动（端口3000）
- [ ] 用户端已启动（端口3000或自动分配）
- [ ] 后台管理已启动（端口3001）
- [ ] 可以访问后端API（http://localhost:3000/api/products）
- [ ] 可以访问用户端（http://localhost:3000）
- [ ] 可以访问后台管理（http://localhost:3001/admin）

---

## 八、测试关联

### 测试1：后台配置 → 用户端显示

1. 在后台管理系统添加产品
2. 在用户端查看产品列表
3. 验证数据是否同步

### 测试2：用户端提交 → 后台查看

1. 在用户端提交投保单
2. 在后台管理系统查看投保单
3. 验证数据是否保存

---

**启动完成后，就可以看到三个系统的关联了！** 🎉

