# 前端客户端与后台配置系统集成说明

## 一、已创建的文件

### 1. API服务层
- `src/services/api.ts` - 前端API封装（使用fetch，不依赖axios）

### 2. 自定义Hook
- `src/hooks/useProductPlans.ts` - 获取产品和方案数据的Hook

### 3. 动态组件
- `src/components/PlanSelectionDynamic.tsx` - 动态方案选择组件

### 4. 文档
- `前端与后台打通方案.md` - 详细的打通方案说明

---

## 二、如何使用

### 方式1：替换现有组件（推荐）

在 `pages/NewPolicy.tsx` 中：

```typescript
// 导入动态组件
import PlanSelectionDynamic from '../src/components/PlanSelectionDynamic';

// 替换原有的 PlanSelection 组件
{currentStep === 1 && (
  <PlanSelectionDynamic
    plans={plans}
    setPlans={setPlans}
    companyInfo={companyInfo}
    setCompanyInfo={setCompanyInfo}
    onNext={() => setCurrentStep(2)}
  />
)}
```

### 方式2：修改现有组件

在 `pages/NewPolicy.tsx` 的 `PlanSelection` 组件中：

```typescript
import { useProductPlans } from '../src/hooks/useProductPlans';
import { calculatePremium } from '../src/services/api';

const PlanSelection = ({ ... }) => {
  const { products, plans: availablePlans, planLiabilities, fetchProducts, fetchPlans, fetchPlanLiabilities } = useProductPlans();
  
  // 使用API获取数据，而不是硬编码
  useEffect(() => {
    fetchProducts();
  }, []);
  
  // ... 其他逻辑
};
```

---

## 三、数据流程

### 3.1 完整流程

```
1. 用户进入投保页面
   ↓
2. 调用 getProducts() → 显示产品列表
   ↓
3. 用户选择产品
   ↓
4. 调用 getPlans(productId) → 显示方案列表
   ↓
5. 用户选择方案
   ↓
6. 调用 getPlanLiabilities(planId) → 显示责任和保额选项
   ↓
7. 用户选择责任和保额
   ↓
8. 调用 calculatePremium() → 显示计算后的保费
   ↓
9. 用户填写被保人信息
   ↓
10. 调用 createApplication() → 提交投保
   ↓
11. 数据保存到数据库
```

---

## 四、关键改动点

### 4.1 产品选择

**之前**：硬编码产品信息
```typescript
<span>Enterprise Liability Insurance (Classic Edition)</span>
```

**之后**：从API获取
```typescript
<select onChange={(e) => setSelectedProductId(Number(e.target.value))}>
  {products.map(product => (
    <option value={product.product_id}>{product.product_name}</option>
  ))}
</select>
```

### 4.2 方案选择

**之前**：硬编码方案
```typescript
const newPlan: PlanConfig = {
  name: '方案一',
  jobClass: '1~3类',
  deathBenefit: '10万',
  // ...
};
```

**之后**：从API获取
```typescript
<select onChange={(e) => handleSelectPlan(plan.id, Number(e.target.value))}>
  {availablePlans.map(plan => (
    <option value={plan.plan_id}>{plan.plan_name}</option>
  ))}
</select>
```

### 4.3 责任选项

**之前**：硬编码选项
```typescript
<select>
  <option value="10万">10万</option>
  <option value="30万">30万</option>
  <option value="50万">50万</option>
</select>
```

**之后**：从API获取
```typescript
<select>
  {liability.coverage_options.map(option => (
    <option value={option}>{option}</option>
  ))}
</select>
```

### 4.4 保费计算

**之前**：硬编码公式
```typescript
const calculatePlanPrice = (plan: PlanConfig) => {
  let base = 81;
  const factors = {...};
  return Math.round(price);
};
```

**之后**：调用API
```typescript
const result = await calculatePremium({
  product_id: selectedProductId,
  plan_id: planId,
  liability_selections: [...],
  job_class: plan.jobClass,
  insured_count: plan.insuredCount,
});
return result.premium_per_person;
```

---

## 五、数据结构映射

### 5.1 前端提交的数据结构

```typescript
{
  company_info: {
    name: "ABC公司",
    credit_code: "91110000MA01234567",
    // ...
  },
  product_id: 1,
  plan_instances: [
    {
      plan_id: 1,              // 从后台获取的方案ID
      plan_name: "方案一",     // 从后台获取的方案名称
      job_class: "1~3类",     // 用户选择
      duration: "1年",         // 用户选择
      insured_count: 10,       // 用户填写
      liability_selections: [  // 用户选择的责任和保额
        {
          liability_id: 1,     // 从后台获取的责任ID
          coverage_amount: "30万", // 用户选择的保额
          unit: "元"
        }
      ]
    }
  ],
  effective_date: "2025-01-01",
  expiry_date: "2026-01-01"
}
```

### 5.2 后端保存的数据结构

**applications 表**：
- 保存投保单基本信息

**application_plans 表**：
- 保存方案实例（plan_id、plan_name、job_class、duration、insured_count）

**plan_instance_liabilities 表**：
- 保存责任选择（liability_id、coverage_amount、unit）

---

## 六、环境变量配置

在项目根目录创建 `.env.local` 文件：

```env
VITE_API_BASE_URL=http://localhost:3000/api
```

---

## 七、注意事项

1. **API地址**：确保后端API地址正确
2. **CORS配置**：后端需要配置CORS，允许前端访问
3. **错误处理**：需要处理API调用失败的情况
4. **加载状态**：需要显示数据加载状态
5. **数据验证**：前端需要验证用户输入

---

## 八、测试步骤

1. **启动后端服务**（如果已开发）
2. **启动前端服务**：`npm run dev`
3. **测试产品选择**：验证能否获取产品列表
4. **测试方案选择**：验证能否获取方案列表
5. **测试责任配置**：验证能否获取责任和保额选项
6. **测试保费计算**：验证能否正确计算保费
7. **测试提交投保**：验证能否正确提交数据

---

## 九、后续开发

1. **开发后端API**：实现上述API接口
2. **完善错误处理**：添加更完善的错误提示
3. **优化用户体验**：添加加载动画、优化交互
4. **数据缓存**：缓存不常变化的数据（如产品列表）
5. **数据验证**：添加更完善的前端验证

