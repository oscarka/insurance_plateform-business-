# 完整测试流程

## 一、环境准备

### 1.1 创建数据库

```bash
# 1. 创建数据库和表结构
mysql -u root -p < database_schema.sql

# 2. 初始化测试数据
mysql -u root -p < backend/init-test-data.sql
```

### 1.2 启动后端服务

```bash
cd backend
npm install
cp .env.example .env
# 编辑 .env 文件，配置数据库连接
npm run dev
```

### 1.3 启动前端服务

```bash
# 前端客户端（用户端）
npm run dev

# 后台管理系统（新终端）
cd admin
npm install
npm run dev
```

---

## 二、测试步骤

### 步骤1：测试后端API（自动化）

```bash
cd backend
npm test
```

**预期输出**：
```
🚀 开始API测试
==================================================
🧪 测试: 健康检查
✅ 通过: 健康检查
🧪 测试: 获取保司列表
✅ 通过: 获取保司列表
   返回 1 个保司
...
✨ 测试完成
```

### 步骤2：测试后端API（手动）

#### 2.1 测试产品列表

```bash
curl http://localhost:3000/api/products
```

**验证点**：
- ✅ 返回成功响应
- ✅ 包含产品数据
- ✅ 产品包含保司信息

#### 2.2 测试方案列表

```bash
curl http://localhost:3000/api/products/1/plans
```

**验证点**：
- ✅ 返回成功响应
- ✅ 包含方案数据
- ✅ duration_options 是数组格式

#### 2.3 测试方案责任配置

```bash
curl http://localhost:3000/api/plans/1/liabilities
```

**验证点**：
- ✅ 返回成功响应
- ✅ 包含责任配置
- ✅ coverage_options 是数组格式
- ✅ 包含保额选项（如：["10万","30万","50万"]）

#### 2.4 测试保费计算

```bash
curl -X POST http://localhost:3000/api/premium/calculate \
  -H "Content-Type: application/json" \
  -d '{
    "product_id": 1,
    "plan_id": 1,
    "liability_selections": [
      {"liability_id": 1, "coverage_amount": "10万"},
      {"liability_id": 2, "coverage_amount": "1万"}
    ],
    "job_class": "1~3类",
    "insured_count": 10
  }'
```

**验证点**：
- ✅ 返回成功响应
- ✅ premium_per_person 有值
- ✅ total_premium = premium_per_person × insured_count
- ✅ premium_details 包含详细计算信息

#### 2.5 测试创建投保单

```bash
curl -X POST http://localhost:3000/api/applications \
  -H "Content-Type: application/json" \
  -d '{
    "company_info": {
      "name": "测试企业有限公司",
      "credit_code": "TEST'$(date +%s)'",
      "province": "北京市",
      "city": "北京市",
      "district": "通州区",
      "address": "测试地址123号",
      "contact_name": "测试联系人",
      "contact_phone": "13800138000",
      "contact_email": "test@example.com"
    },
    "product_id": 1,
    "plan_instances": [
      {
        "plan_id": 1,
        "plan_name": "方案一",
        "job_class": "1~3类",
        "duration": "1年",
        "insured_count": 10,
        "liability_selections": [
          {
            "liability_id": 1,
            "coverage_amount": "10万",
            "unit": "元"
          },
          {
            "liability_id": 2,
            "coverage_amount": "1万",
            "unit": "元"
          }
        ]
      }
    ],
    "effective_date": "2025-01-01",
    "expiry_date": "2026-01-01"
  }'
```

**验证点**：
- ✅ 返回成功响应
- ✅ 返回 application_id 和 application_no
- ✅ 数据库中有对应的记录

### 步骤3：验证数据库数据

```sql
-- 查看投保单
SELECT * FROM applications ORDER BY created_at DESC LIMIT 1;

-- 查看方案实例
SELECT ap.*, pp.plan_name as plan_template_name
FROM application_plans ap
INNER JOIN product_plans pp ON ap.plan_id = pp.plan_id
ORDER BY ap.created_at DESC LIMIT 1;

-- 查看责任选择
SELECT pil.*, cl.liability_name
FROM plan_instance_liabilities pil
INNER JOIN company_liabilities cl ON pil.liability_id = cl.liability_id
ORDER BY pil.created_at DESC LIMIT 5;
```

**验证点**：
- ✅ applications 表有记录
- ✅ application_plans 表有记录
- ✅ plan_instance_liabilities 表有记录
- ✅ 数据关联正确

### 步骤4：测试前端客户端

1. **访问前端**：http://localhost:3000/new-policy

2. **测试产品选择**：
   - ✅ 应该显示从API获取的产品列表
   - ✅ 选择产品后，应该显示方案列表

3. **测试方案选择**：
   - ✅ 选择方案后，应该显示责任配置
   - ✅ 责任配置应该显示保额选项（从API获取）

4. **测试责任选择**：
   - ✅ 选择责任和保额后，应该自动计算保费
   - ✅ 保费应该从API获取（不是硬编码）

5. **测试提交投保**：
   - ✅ 填写完整信息后提交
   - ✅ 应该成功创建投保单
   - ✅ 数据库中有对应记录

### 步骤5：测试后台管理系统

1. **访问后台**：http://localhost:3001/admin

2. **测试保司管理**：
   - ✅ 查看保司列表
   - ✅ 添加/编辑保司

3. **测试责任管理**：
   - ✅ 查看责任列表
   - ✅ 添加/编辑责任

4. **测试产品管理**：
   - ✅ 查看产品列表
   - ✅ 添加/编辑产品

5. **测试方案管理**：
   - ✅ 查看方案列表
   - ✅ 配置方案责任（核心功能）

6. **测试配置导入**：
   - ✅ 上传配置文件
   - ✅ 验证导入结果

---

## 三、测试检查清单

### 3.1 后端API测试

- [ ] ✅ 健康检查接口
- [ ] ✅ 获取保司列表
- [ ] ✅ 获取产品列表
- [ ] ✅ 获取方案列表
- [ ] ✅ 获取方案责任配置
- [ ] ✅ 计算保费
- [ ] ✅ 创建投保单
- [ ] ✅ 错误处理

### 3.2 前端客户端测试

- [ ] ✅ 产品选择（从API获取）
- [ ] ✅ 方案选择（从API获取）
- [ ] ✅ 责任配置（从API获取）
- [ ] ✅ 保费计算（调用API）
- [ ] ✅ 提交投保（数据保存）

### 3.3 后台管理系统测试

- [ ] ✅ 保司管理
- [ ] ✅ 责任管理
- [ ] ✅ 产品管理
- [ ] ✅ 方案管理
- [ ] ✅ 方案责任配置（核心）
- [ ] ✅ 费率配置
- [ ] ✅ 配置导入

### 3.4 数据一致性测试

- [ ] ✅ 前端显示的数据与后台配置一致
- [ ] ✅ 提交的数据结构与数据库设计一致
- [ ] ✅ 数据保存完整

---

## 四、问题排查

### 4.1 后端无法启动

**检查**：
1. 数据库连接配置是否正确
2. 数据库是否已创建
3. 端口3000是否被占用

### 4.2 API返回错误

**检查**：
1. 查看服务器控制台错误信息
2. 检查数据库表是否存在
3. 检查测试数据是否已插入

### 4.3 前端无法获取数据

**检查**：
1. 后端服务是否启动
2. API地址是否正确
3. 浏览器控制台是否有错误
4. CORS配置是否正确

---

## 五、测试报告

完成测试后，填写测试报告：

```
测试日期：2025-01-01
测试人员：XXX

后端API测试结果：
✅ 所有接口测试通过

前端客户端测试结果：
✅ 所有功能测试通过

后台管理系统测试结果：
✅ 所有功能测试通过

数据一致性测试结果：
✅ 数据保存完整，结构正确

问题记录：
无

测试结论：
系统功能正常，可以投入使用。
```

