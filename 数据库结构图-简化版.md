# 数据库结构图（简化版）

## 一、核心业务表结构

### 1.1 企业相关
```
companies (投保企业表)
    ├── company_id (主键)
    ├── company_name
    ├── credit_code
    └── ...
    │
    ├─→ applications (投保单) [一对多]
    └─→ policies (保单) [一对多]
```

### 1.2 产品与责任相关
```
insurance_products (保司产品表)
    ├── product_id (主键)
    ├── product_code
    ├── product_name
    └── insurance_company_code
    │
    ├─→ product_liabilities (产品责任关联) [一对多]
    │       ├── product_id (外键)
    │       ├── liability_id (外键)
    │       ├── coverage_options (保额选项)
    │       └── is_required (是否必选)
    │
    ├─→ product_plan_templates (方案模板) [一对多]
    │       ├── template_id (主键)
    │       ├── product_id (外键)
    │       └── template_name
    │
    └─→ premium_rates (费率配置) [一对多]
            ├── rate_id (主键)
            ├── product_id (外键)
            ├── liability_id (外键)
            └── job_class (职业类别)

insurance_liabilities (保险责任表)
    ├── liability_id (主键)
    ├── liability_code (责任代码)
    ├── liability_name (责任名称)
    └── liability_type (责任类型)
    │
    ├─→ product_liabilities (产品责任关联) [多对多]
    └─→ plan_liabilities (方案责任关联) [多对多]
```

### 1.3 方案相关
```
insurance_plans (投保方案表)
    ├── plan_id (主键)
    ├── plan_name (方案名称)
    ├── job_class (职业类别)
    ├── duration (保障时间)
    └── base_premium (基础保费)
    │
    ├─→ plan_liabilities (方案责任关联) [一对多]
    │       ├── plan_id (外键)
    │       ├── liability_id (外键)
    │       ├── coverage_amount (保额)
    │       └── coverage_value (保额数值)
    │
    ├─→ application_plans (投保单方案关联) [多对多]
    └─→ insured_persons (被保人) [一对多]
```

### 1.4 投保流程相关
```
applications (投保单表)
    ├── application_id (主键)
    ├── application_no (投保单号)
    ├── company_id (外键 → companies)
    ├── product_code
    ├── total_premium (总保费)
    ├── status (状态)
    └── ...
    │
    ├─→ application_plans (投保单方案关联) [一对多]
    │       ├── application_id (外键)
    │       ├── plan_id (外键)
    │       └── insured_count (被保人数)
    │
    ├─→ insured_persons (被保人) [一对多]
    │       ├── person_id (主键)
    │       ├── application_id (外键)
    │       ├── plan_id (外键)
    │       ├── name (姓名)
    │       ├── job_category (职业类别)
    │       └── individual_premium (个人保费)
    │
    └─→ policies (保单) [一对一]
            ├── policy_id (主键)
            ├── policy_no (保单号)
            ├── application_id (外键)
            └── ...
```

### 1.5 保单后续业务相关
```
policies (保单表)
    ├── policy_id (主键)
    ├── policy_no (保单号)
    ├── application_id (外键)
    └── ...
    │
    ├─→ endorsements (批改申请) [一对多]
    │       ├── endorsement_id (主键)
    │       ├── policy_id (外键)
    │       ├── endorsement_type (批改类型)
    │       └── ...
    │       │
    │       └─→ endorsement_persons (批改被保人明细) [一对多]
    │
    ├─→ renewals (续保申请) [一对多]
    │       ├── renewal_id (主键)
    │       ├── original_policy_id (外键)
    │       └── new_policy_id (外键)
    │
    ├─→ invoices (发票申请) [一对多]
    └─→ receipts (回执) [一对多]
```

## 二、接口对接相关表结构

### 2.1 渠道与配置
```
channels (渠道配置表)
    ├── channel_id (主键)
    ├── channel_code (渠道代码)
    ├── insurance_company_code
    ├── api_base_url
    └── ...
    │
    ├─→ api_field_mappings (字段映射) [一对多]
    │       ├── channel_id (外键)
    │       ├── system_field (系统字段)
    │       ├── api_field (接口字段)
    │       └── format_rule (格式规则)
    │
    └─→ underwriting_intercept_rules (拦截规则) [一对多]
            ├── channel_id (外键)
            ├── rule_name (规则名称)
            ├── check_field (检查字段)
            └── priority (优先级)
```

### 2.2 接口任务与日志
```
insurance_api_tasks (接口任务表)
    ├── task_id (主键)
    ├── task_type (任务类型)
    ├── business_id (业务ID)
    ├── status (状态)
    └── retry_count (重试次数)

insurance_api_logs (接口日志表)
    ├── log_id (主键)
    ├── api_name (接口名称)
    ├── request_body (请求体)
    ├── response_body (响应体)
    └── business_id (业务ID)
```

## 三、系统管理表结构

```
users (用户表)
    ├── user_id (主键)
    ├── username
    ├── phone
    └── role
    │
    └─→ operation_logs (操作日志) [一对多]
            ├── log_id (主键)
            ├── user_id (外键)
            └── operation_type (操作类型)
```

## 四、核心业务流程数据流转

### 4.1 投保流程
```
1. companies (企业信息)
   ↓
2. insurance_products (选择产品)
   ↓
3. product_liabilities (查看产品支持的责任和保额选项)
   ↓
4. insurance_plans (创建方案)
   ↓
5. plan_liabilities (选择责任和保额)
   ↓
6. applications (创建投保单)
   ↓
7. application_plans (关联方案)
   ↓
8. insured_persons (添加被保人)
   ↓
9. premium_rates (计算保费)
```

### 4.2 承保流程
```
1. applications (投保单，状态：核保通过)
   ↓
2. underwriting_intercept_rules (拦截规则检查)
   ↓
3. api_field_mappings (字段映射转换)
   ↓
4. channels (获取渠道配置)
   ↓
5. insurance_api_tasks (创建接口任务)
   ↓
6. insurance_api_logs (记录接口调用)
   ↓
7. policies (创建保单)
```

## 五、表关系汇总

### 5.1 一对多关系
- companies → applications (一个企业多个投保单)
- companies → policies (一个企业多个保单)
- insurance_products → product_liabilities (一个产品多个责任)
- insurance_products → product_plan_templates (一个产品多个方案模板)
- insurance_plans → plan_liabilities (一个方案多个责任)
- applications → application_plans (一个投保单多个方案)
- applications → insured_persons (一个投保单多个被保人)
- policies → endorsements (一个保单多个批改)
- policies → renewals (一个保单多个续保)
- channels → api_field_mappings (一个渠道多个字段映射)
- channels → underwriting_intercept_rules (一个渠道多个拦截规则)

### 5.2 多对多关系
- insurance_products ↔ insurance_liabilities (通过 product_liabilities)
- insurance_plans ↔ insurance_liabilities (通过 plan_liabilities)
- applications ↔ insurance_plans (通过 application_plans)

### 5.3 一对一关系
- applications ↔ policies (一个投保单对应一个保单)

## 六、表清单（共28张）

### 核心业务表（16张）
1. companies - 投保企业表
2. insurance_products - 保司产品表
3. insurance_liabilities - 保险责任表
4. product_liabilities - 产品责任关联表
5. product_plan_templates - 产品方案模板表
6. insurance_plans - 投保方案表
7. plan_liabilities - 方案责任关联表
8. applications - 投保单表
9. application_plans - 投保单方案关联表
10. insured_persons - 被保人表
11. policies - 保单表
12. endorsements - 批改申请表
13. endorsement_persons - 批改被保人明细表
14. renewals - 续保申请表
15. invoices - 发票申请表
16. receipts - 回执表

### 接口对接表（7张）
17. channels - 渠道配置表
18. api_field_mappings - 接口字段映射表
19. underwriting_intercept_rules - 承保拦截规则表
20. data_validation_rules - 数据校验规则表
21. insurance_api_tasks - 保司接口任务表
22. insurance_api_logs - 保司接口调用日志表
23. insurance_api_configs - 保司接口配置表

### 配置管理表（1张）
24. premium_rates - 费率配置表

### 系统管理表（2张）
25. users - 用户表
26. operation_logs - 操作日志表

## 七、关键字段说明

### 7.1 责任管理核心字段
- `insurance_liabilities.liability_code` - 责任代码（唯一标识）
- `product_liabilities.coverage_options` - 保额选项（JSON格式）
- `plan_liabilities.coverage_amount` - 用户选择的保额

### 7.2 业务流程核心字段
- `applications.application_no` - 投保单号（唯一）
- `policies.policy_no` - 保单号（唯一，保司返回）
- `applications.status` - 投保单状态
- `policies.status` - 保单状态

### 7.3 接口对接核心字段
- `channels.channel_code` - 渠道代码（唯一）
- `api_field_mappings.system_field` - 系统字段名
- `api_field_mappings.api_field` - 保司接口字段名
- `underwriting_intercept_rules.priority` - 规则优先级

