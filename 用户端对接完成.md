# 用户端对接完成 ✅

## 一、已完成的修改

### 1. 替换为动态组件 ✅
- ✅ `pages/NewPolicy.tsx` 中的 `PlanSelection` 已替换为 `PlanSelectionDynamic`
- ✅ 动态组件会从后端API获取产品、方案和责任配置

### 2. 后端API过滤 ✅
- ✅ `backend/routes/products.js` 只返回状态为"启用"的产品
- ✅ SQL查询：`WHERE (p.status = '启用' OR p.status IS NULL OR p.status = '')`

### 3. 前端API处理 ✅
- ✅ `src/services/api.ts` 正确处理后端返回格式
- ✅ `getProducts()` 提取 `response.data`
- ✅ `getPlans()` 和 `getPlanLiabilities()` 同样处理

### 4. Hook数据处理 ✅
- ✅ `src/hooks/useProductPlans.ts` 确保只显示启用的产品
- ✅ 二次过滤：`filter((p: any) => !p.status || p.status === '启用')`

---

## 二、数据流程

```
后台管理系统 (5174)
  ↓ 配置产品（状态：启用）
  ↓ 保存到数据库
  ↓
后端API (8888)
  ↓ 查询启用的产品
  ↓ SQL: WHERE status = '启用'
  ↓ 返回：{ success: true, data: [...], count: ... }
  ↓
用户端 (5173)
  ↓ 调用 getProducts()
  ↓ 提取 response.data
  ↓ 二次过滤（确保只显示启用）
  ↓ 显示产品列表
```

---

## 三、验证步骤

### 步骤1：在后台管理系统配置产品

1. 访问：http://localhost:5174/admin/products
2. 确保产品状态为"启用"
3. 如果没有产品，点击"+ 添加产品"创建

### 步骤2：验证后端API

```bash
# 测试产品列表API
curl http://localhost:8888/api/products

# 应该返回：
# {
#   "success": true,
#   "data": [
#     {
#       "product_id": 1,
#       "product_name": "雇主责任险A",
#       "status": "启用",
#       "company_name": "利宝保险",
#       ...
#     }
#   ],
#   "count": 1
# }
```

### 步骤3：在用户端查看

1. 访问：http://localhost:5173/#/new-policy
2. 应该能看到后台配置的启用产品
3. 选择产品后，应该能看到该产品的方案列表
4. 选择方案后，应该能看到责任配置和保额选项

---

## 四、关键修改点

### 1. NewPolicy.tsx
```typescript
// 导入动态组件
import PlanSelectionDynamic from '../src/components/PlanSelectionDynamic';

// 使用动态组件
<PlanSelectionDynamic 
  plans={plans} 
  setPlans={setPlans} 
  companyInfo={companyInfo}
  setCompanyInfo={setCompanyInfo}
  onNext={() => setCurrentStep(2)} 
/>
```

### 2. backend/routes/products.js
```javascript
// 只返回启用的产品
WHERE (p.status = '启用' OR p.status IS NULL OR p.status = '')
```

### 3. src/services/api.ts
```typescript
// 处理后端返回格式
export const getProducts = async (params?: { company_code?: string }) => {
  const response = await request(`/products${queryString}`);
  return response.data || response; // 提取data数组
};
```

### 4. src/hooks/useProductPlans.ts
```typescript
// 二次过滤，确保只显示启用的产品
const enabledProducts = Array.isArray(productList) 
  ? productList.filter((p: any) => !p.status || p.status === '启用')
  : [];
```

---

## 五、测试清单

- [ ] 后端API返回启用的产品
- [ ] 用户端能获取产品列表
- [ ] 用户端只显示启用的产品
- [ ] 选择产品后能显示方案列表
- [ ] 选择方案后能显示责任配置
- [ ] 保费计算功能正常

---

## 六、故障排查

### 问题1：用户端看不到产品

**检查**：
1. 后端服务是否启动：`curl http://localhost:8888/health`
2. 产品是否启用：在后台管理系统查看产品状态
3. 浏览器控制台是否有错误（F12 → Console）
4. 网络请求是否成功（F12 → Network → 查看 /api/products 请求）

**解决**：
- 确保后端服务运行在8888端口
- 确保产品状态为"启用"
- 检查API地址配置：`http://localhost:8888/api`

### 问题2：API返回空数组

**检查**：
```sql
-- 检查产品状态
SELECT product_id, product_name, status 
FROM insurance_products 
WHERE status = '启用' OR status IS NULL;
```

**解决**：
- 在后台管理系统将产品状态设置为"启用"
- 或者直接在数据库更新：`UPDATE insurance_products SET status = '启用' WHERE product_id = 1;`

### 问题3：跨域错误

**检查**：
- 浏览器控制台是否有CORS错误

**解决**：
- 后端已配置CORS，允许所有来源
- 确保API地址正确：`http://localhost:8888/api`

---

**现在用户端已经可以读取后台配置的启用产品了！** ✅

刷新用户端页面，应该能看到后台配置的产品。

