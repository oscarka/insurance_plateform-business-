# 环境变量不生效深度排查

## 🔍 问题现象

- 环境变量已在Cloudflare Pages中设置：`VITE_API_BASE_URL = https://insuranceplateform-business-production.up.railway.app/api`
- 已重新部署2次
- 但前端仍在请求 `localhost:8888`

## 💡 可能的原因

### 1. 环境变量设置在了错误的环境

**检查**：
- 确认在 **Production** 环境中设置了变量
- 如果访问的是预览URL（如 `*-*.pages.dev`），需要在 **Preview** 环境中设置
- 或者在 **All environments** 中设置

### 2. 环境变量名称错误

**检查**：
- 必须是：`VITE_API_BASE_URL`（完全一致，区分大小写）
- 不能是：`VITE_API_URL`、`API_BASE_URL` 等

### 3. Vite环境变量必须以 `VITE_` 开头

**检查**：
- ✅ 正确：`VITE_API_BASE_URL`
- ❌ 错误：`API_BASE_URL`（没有 `VITE_` 前缀）

### 4. 构建时环境变量未注入

**检查**：
- 在Cloudflare Pages的构建日志中，查看是否有环境变量相关的信息
- 确认构建过程是否成功

### 5. 浏览器缓存了旧版本

**解决**：
- 强制刷新：`Ctrl+Shift+R`（Windows）或 `Cmd+Shift+R`（Mac）
- 或在开发者工具中勾选 "Disable cache"

## ✅ 解决步骤

### 步骤1：确认环境变量设置

1. **进入Cloudflare Pages项目**
   - 访问 https://pages.cloudflare.com
   - 进入后台前端项目

2. **检查环境变量**
   - Settings → Environment variables
   - 确认：
     - ✅ 变量名：`VITE_API_BASE_URL`（完全一致）
     - ✅ 值：`https://insuranceplateform-business-production.up.railway.app/api`
     - ✅ 环境：**Production**（或 All environments）

3. **截图保存**（用于排查）

### 步骤2：检查构建日志

1. **进入Deployments标签**
2. **查看最新部署的构建日志**
3. **搜索关键词**：
   - `VITE_API_BASE_URL`
   - `environment variable`
   - `build`

4. **确认**：
   - 环境变量是否在构建时被读取
   - 是否有构建错误

### 步骤3：使用调试代码验证

我已经在 `admin/src/utils/api.ts` 中添加了调试代码，部署后：

1. **打开部署的页面**
2. **打开浏览器控制台**（F12）
3. **查看日志**，应该看到：
   ```
   [API配置] 环境变量 VITE_API_BASE_URL: https://insuranceplateform-business-production.up.railway.app/api
   [API配置] 最终使用的API地址: https://insuranceplateform-business-production.up.railway.app/api
   ```

4. **如果显示 `undefined` 或 `http://localhost:8888/api`**：
   - 说明环境变量没有生效
   - 继续下面的排查步骤

### 步骤4：手动验证环境变量

在浏览器控制台执行：

```javascript
// 方法1：直接查看环境变量
console.log('VITE_API_BASE_URL:', import.meta.env.VITE_API_BASE_URL);
console.log('所有环境变量:', import.meta.env);

// 方法2：查看全局变量（如果代码已部署）
console.log('API Base URL:', window.__API_BASE_URL__);
```

### 步骤5：检查Cloudflare Pages构建配置

1. **进入Settings → Builds & deployments**
2. **检查构建命令**：
   - 应该是：`cd admin && npm install && npm run build`
   - 或者：`npm install && npm run build`（如果Root directory设置为 `/`）

3. **检查Root directory**：
   - 如果Root directory是 `/`，构建命令应该是：`cd admin && npm install && npm run build`
   - 如果Root directory是 `admin`，构建命令应该是：`npm install && npm run build`

### 步骤6：尝试在构建命令中直接设置环境变量

如果环境变量还是不生效，可以在构建命令中直接设置：

**修改构建命令**：
```bash
VITE_API_BASE_URL=https://insuranceplateform-business-production.up.railway.app/api cd admin && npm install && npm run build
```

**注意**：这种方法不推荐，因为环境变量会暴露在构建日志中。

## 🔧 临时解决方案

如果环境变量一直不生效，可以临时修改代码：

### 方案1：在代码中直接设置（不推荐，仅用于测试）

在 `admin/src/utils/api.ts` 中：

```typescript
const api = axios.create({
  baseURL: 'https://insuranceplateform-business-production.up.railway.app/api',
  timeout: 30000,
});
```

**注意**：这只是临时方案，用于验证是否是环境变量的问题。

### 方案2：使用 `.env.production` 文件

在 `admin/` 目录创建 `.env.production` 文件：

```
VITE_API_BASE_URL=https://insuranceplateform-business-production.up.railway.app/api
```

然后提交到Git，Cloudflare Pages构建时会读取这个文件。

## 📋 完整检查清单

- [ ] 环境变量名称：`VITE_API_BASE_URL`（完全一致，区分大小写）
- [ ] 环境变量值：`https://insuranceplateform-business-production.up.railway.app/api`
- [ ] 环境：**Production**（生产环境）
- [ ] 已重新部署（Retry deployment）
- [ ] 检查构建日志，确认环境变量被读取
- [ ] 在浏览器控制台验证：`import.meta.env.VITE_API_BASE_URL`
- [ ] 清除浏览器缓存并强制刷新
- [ ] 检查构建命令和Root directory配置

## 🎯 下一步

1. **先检查环境变量设置**（步骤1）
2. **查看构建日志**（步骤2）
3. **使用调试代码验证**（步骤3）
4. **如果还是不行，尝试方案2**（创建 `.env.production` 文件）

---

**我已经在代码中添加了调试信息，重新部署后可以在浏览器控制台看到详细的API配置信息！**
