# 保险平台部署指南

## 一、部署架构

### 推荐方案：前后端分离部署

```
┌─────────────────┐
│  用户端前端      │  Cloudflare Pages (免费)
│  (React)        │  或 Vercel / Netlify
└─────────────────┘
         │
         │ HTTPS
         ▼
┌─────────────────┐
│  后台管理前端    │  Cloudflare Pages (免费)
│  (React + AntD) │  或 Vercel / Netlify
└─────────────────┘
         │
         │ HTTPS
         ▼
┌─────────────────┐
│  后端API服务     │  Railway (推荐) 或 Render
│  (Node.js)      │  或 Heroku / Fly.io
└─────────────────┘
         │
         │
         ▼
┌─────────────────┐
│  MySQL数据库     │  Railway MySQL (推荐)
│                 │  或 PlanetScale / Supabase
└─────────────────┘
```

## 二、后端部署（Railway）

### 2.1 为什么选择Railway？

✅ **优点：**
- 支持Node.js和MySQL一体化部署
- 自动配置环境变量
- 免费额度：$5/月（足够小项目使用）
- 支持GitHub自动部署
- 提供数据库服务（MySQL）
- 简单易用，无需Docker配置

### 2.2 部署步骤

#### 步骤1：准备Railway配置文件

在 `backend/` 目录创建 `railway.json`：

```json
{
  "$schema": "https://railway.app/railway.schema.json",
  "build": {
    "builder": "NIXPACKS"
  },
  "deploy": {
    "startCommand": "node server.js",
    "restartPolicyType": "ON_FAILURE",
    "restartPolicyMaxRetries": 10
  }
}
```

#### 步骤2：创建 `Procfile`（可选）

在 `backend/` 目录创建 `Procfile`：

```
web: node server.js
```

#### 步骤3：修改 `server.js` 监听端口

确保服务器监听环境变量端口：

```javascript
const PORT = process.env.PORT || 3000;
// 已经正确配置 ✅
```

#### 步骤4：在Railway部署

1. 访问 [Railway.app](https://railway.app)
2. 使用GitHub账号登录
3. 点击 "New Project" → "Deploy from GitHub repo"
4. 选择你的仓库
5. 选择 `backend` 目录作为根目录
6. 添加环境变量（见下方）

#### 步骤5：配置环境变量

在Railway项目设置中添加：

```
DB_HOST=containers-us-west-xxx.railway.app
DB_PORT=3306
DB_USER=root
DB_PASSWORD=your_password
DB_NAME=railway
PORT=3000
NODE_ENV=production
```

#### 步骤6：添加MySQL数据库

1. 在Railway项目中点击 "New" → "Database" → "MySQL"
2. Railway会自动创建数据库并设置环境变量
3. 更新环境变量中的数据库连接信息

#### 步骤7：初始化数据库

在Railway的部署日志中，运行数据库初始化：

```bash
# 在Railway的终端中执行
cd backend
node execute-sql.js
```

或者使用Railway的MySQL客户端连接数据库，执行 `database_schema.sql`

### 2.3 获取后端API地址

部署成功后，Railway会提供一个URL，例如：
```
https://your-backend.railway.app
```

API地址为：
```
https://your-backend.railway.app/api
```

## 三、前端部署（Cloudflare Pages）

### 3.1 为什么选择Cloudflare Pages？

✅ **优点：**
- **完全免费**（无限制）
- 全球CDN加速
- 自动HTTPS
- 支持GitHub自动部署
- 构建速度快
- 支持环境变量

### 3.2 用户端前端部署

#### 步骤1：修改API地址

在 `src/services/api.ts` 中，确保使用环境变量：

```typescript
const API_BASE_URL = import.meta.env.VITE_API_BASE_URL || 'http://localhost:8888/api';
```

#### 步骤2：创建 `.env.production`

在项目根目录创建 `.env.production`：

```
VITE_API_BASE_URL=https://your-backend.railway.app/api
```

#### 步骤3：在Cloudflare Pages部署

1. 访问 [Cloudflare Pages](https://pages.cloudflare.com)
2. 使用GitHub账号登录
3. 点击 "Create a project" → "Connect to Git"
4. 选择你的仓库
5. 配置构建设置：
   - **Framework preset**: Vite
   - **Build command**: `npm run build`
   - **Build output directory**: `dist`
   - **Root directory**: `/` (项目根目录)
6. 添加环境变量：
   - `VITE_API_BASE_URL`: `https://your-backend.railway.app/api`
7. 点击 "Save and Deploy"

### 3.3 后台管理前端部署

#### 步骤1：修改API地址

在 `admin/src/utils/api.ts` 中，确保使用环境变量：

```typescript
const api = axios.create({
  baseURL: import.meta.env?.VITE_API_BASE_URL || 'http://localhost:8888/api',
  // ...
});
```

#### 步骤2：创建 `admin/.env.production`

在 `admin/` 目录创建 `.env.production`：

```
VITE_API_BASE_URL=https://your-backend.railway.app/api
```

#### 步骤3：在Cloudflare Pages部署（新项目）

1. 在Cloudflare Pages创建**新项目**
2. 配置构建设置：
   - **Framework preset**: Vite
   - **Build command**: `cd admin && npm run build`
   - **Build output directory**: `admin/dist`
   - **Root directory**: `/` (项目根目录)
3. 添加环境变量：
   - `VITE_API_BASE_URL`: `https://your-backend.railway.app/api`
4. 部署

## 四、CORS配置

### 4.1 修改后端CORS设置

在 `backend/server.js` 中，更新CORS配置：

```javascript
import cors from 'cors';

// 允许的前端域名
const allowedOrigins = [
  'https://your-user-frontend.pages.dev',
  'https://your-admin-frontend.pages.dev',
  'http://localhost:5173',  // 本地开发
  'http://localhost:5174',  // 本地开发
];

app.use(cors({
  origin: function (origin, callback) {
    // 允许没有origin的请求（如移动应用、Postman等）
    if (!origin) return callback(null, true);
    
    if (allowedOrigins.indexOf(origin) !== -1 || process.env.NODE_ENV === 'development') {
      callback(null, true);
    } else {
      callback(new Error('Not allowed by CORS'));
    }
  },
  credentials: true,
}));
```

或者更简单的方式（生产环境）：

```javascript
app.use(cors({
  origin: process.env.FRONTEND_URL || '*',
  credentials: true,
}));
```

在Railway环境变量中添加：
```
FRONTEND_URL=https://your-user-frontend.pages.dev,https://your-admin-frontend.pages.dev
```

## 五、数据库迁移

### 5.1 在Railway MySQL中执行SQL

1. 在Railway项目中找到MySQL服务
2. 点击 "Query" 或使用MySQL客户端连接
3. 执行 `database_schema.sql` 创建表结构
4. 执行 `database_create_regions_table.sql` 创建地区表
5. 执行 `database_extend_special_agreements.sql` 扩展表结构
6. 执行 `database_migration_task1-12.sql` 迁移数据

### 5.2 使用Railway CLI（可选）

```bash
# 安装Railway CLI
npm i -g @railway/cli

# 登录
railway login

# 链接项目
railway link

# 执行SQL文件
railway run mysql < database_schema.sql
```

## 六、其他部署选项

### 6.1 后端替代方案

#### Render
- 免费额度：750小时/月
- 支持Node.js和PostgreSQL
- 需要单独配置MySQL

#### Fly.io
- 免费额度：3个共享CPU实例
- 支持全球部署
- 需要Docker配置

#### Heroku
- 不再提供免费额度
- 需要付费使用

### 6.2 前端替代方案

#### Vercel
- 完全免费
- 自动HTTPS和CDN
- 支持环境变量
- 构建速度快

#### Netlify
- 完全免费
- 自动HTTPS和CDN
- 支持表单处理

#### GitHub Pages
- 完全免费
- 但需要配置构建脚本
- 不支持环境变量（需要其他方式）

## 七、部署检查清单

### 后端检查
- [ ] Railway项目已创建
- [ ] MySQL数据库已添加
- [ ] 环境变量已配置
- [ ] 数据库表结构已创建
- [ ] CORS已配置允许前端域名
- [ ] 健康检查接口 `/health` 可访问
- [ ] API接口 `/api/products` 可访问

### 前端检查
- [ ] Cloudflare Pages项目已创建
- [ ] 环境变量 `VITE_API_BASE_URL` 已设置
- [ ] 构建成功无错误
- [ ] 前端可以正常访问后端API
- [ ] CORS配置正确，无跨域错误

## 八、常见问题

### Q1: Railway免费额度够用吗？
A: 对于小到中型项目，$5/月的免费额度通常足够。如果超出，可以考虑：
- 优化数据库查询
- 使用连接池
- 考虑升级到付费计划

### Q2: Cloudflare Pages有流量限制吗？
A: 没有硬性限制，但建议：
- 合理使用CDN缓存
- 优化前端资源大小
- 使用图片压缩

### Q3: 数据库连接失败怎么办？
A: 检查：
1. Railway MySQL服务是否正常运行
2. 环境变量是否正确
3. 数据库名称是否正确
4. 防火墙规则是否允许连接

### Q4: 前端无法访问后端API？
A: 检查：
1. CORS配置是否正确
2. 后端URL是否正确
3. 环境变量是否设置
4. 浏览器控制台错误信息

## 九、快速部署命令

### Railway部署（使用CLI）

```bash
# 安装Railway CLI
npm i -g @railway/cli

# 登录
railway login

# 初始化项目
cd backend
railway init

# 添加MySQL服务
railway add mysql

# 设置环境变量
railway variables set DB_HOST=${{MySQL.MYSQLHOST}}
railway variables set DB_USER=${{MySQL.MYSQLUSER}}
railway variables set DB_PASSWORD=${{MySQL.MYSQLPASSWORD}}
railway variables set DB_NAME=${{MySQL.MYSQLDATABASE}}
railway variables set PORT=3000

# 部署
railway up
```

### Cloudflare Pages部署（使用Wrangler CLI）

```bash
# 安装Wrangler
npm i -g wrangler

# 登录
wrangler login

# 部署用户端
npm run build
wrangler pages deploy dist --project-name=insurance-platform-user

# 部署后台
cd admin
npm run build
wrangler pages deploy dist --project-name=insurance-platform-admin
```

## 十、监控和维护

### 10.1 Railway监控
- 查看部署日志
- 监控资源使用情况
- 设置告警通知

### 10.2 Cloudflare监控
- 查看访问统计
- 监控带宽使用
- 查看错误日志

### 10.3 数据库备份
Railway MySQL提供自动备份，也可以手动导出：
```bash
railway run mysqldump -u root -p railway > backup.sql
```

---

**部署完成后，记得更新文档中的URL地址！**
