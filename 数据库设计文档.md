# 保险经纪公司业务平台数据库设计文档

## 一、设计概述

### 1.1 系统定位

本系统是**保险经纪公司（渠道）的业务平台**，主要功能包括：
- **客户管理**：管理企业客户信息
- **录单管理**：为企业客户录入投保信息，提交给保司
- **保单管理**：管理从保司返回的保单信息
- **多保司对接**：对接多个保险公司（保司），支持不同保司的产品和接口

### 1.2 核心设计原则

1. **经纪公司视角**：系统是给经纪公司用的，不是给保司用的
2. **多保司支持**：一个经纪公司可以对接多个保司，每个保司有独立的产品和责任体系
3. **配置化管理**：产品和对接信息通过配置文件导入，避免手动逐个配置
4. **责任跟随保司**：保险责任是保司级别的，不同保司的责任虽然名称可能相似，但含义可能完全不同
5. **业务完整性**：覆盖录单、核保、承保、批改、续保等全业务流程
6. **数据可追溯**：所有关键操作都有日志记录，便于问题排查

---

## 二、核心业务表设计

### 2.1 企业客户表（companies）

**设计目的**：存储经纪公司的企业客户信息，这是整个业务流程的基础。

**为什么这样设计**：
- 经纪公司需要管理自己的企业客户
- 企业信息在录单、批改、续保等多个环节都需要使用
- 统一管理客户信息，避免重复录入
- 支持客户风控查询和历史记录追溯

**字段说明**：

| 字段名 | 类型 | 说明 | 是否必填 |
|--------|------|------|----------|
| company_id | BIGINT | 企业ID（主键，自增） | 是 |
| company_name | VARCHAR(200) | 企业名称 | 是 |
| credit_code | VARCHAR(50) | 统一社会信用代码 | 是 |
| province | VARCHAR(50) | 省份 | 是 |
| city | VARCHAR(50) | 城市 | 是 |
| district | VARCHAR(50) | 区县 | 是 |
| address | VARCHAR(500) | 详细地址 | 是 |
| industry | VARCHAR(100) | 行业类型 | 否 |
| contact_name | VARCHAR(50) | 联系人姓名 | 是 |
| contact_phone | VARCHAR(20) | 联系人电话 | 是 |
| contact_email | VARCHAR(100) | 联系人邮箱 | 是 |
| business_license_url | VARCHAR(500) | 营业执照文件路径 | 否 |
| risk_level | VARCHAR(20) | 风控等级（正常/关注/高风险） | 否 |
| risk_query_time | DATETIME | 风控查询时间 | 否 |
| status | VARCHAR(20) | 状态（正常/禁用） | 是 |
| created_at | DATETIME | 创建时间 | 是 |
| updated_at | DATETIME | 更新时间 | 是 |

**使用场景**：
- 投保时填写企业信息，系统自动保存到该表
- 风控查询后更新 risk_level 和 risk_query_time
- 批改和续保时，直接关联企业ID，无需重复填写

---

### 2.2 保司表（insurance_companies）

**设计目的**：存储对接的保险公司（保司）基本信息。

**为什么这样设计**：
- 经纪公司需要对接多个保司
- 每个保司有独立的代码、名称、联系方式等
- 保司信息是产品配置和责任管理的基础

**字段说明**：

| 字段名 | 类型 | 说明 | 是否必填 |
|--------|------|------|----------|
| company_id | BIGINT | 保司ID（主键，自增） | 是 |
| company_code | VARCHAR(50) | 保司代码（唯一，如：LIBO/PINGAN等） | 是 |
| company_name | VARCHAR(200) | 保司名称（如：利宝保险/平安保险） | 是 |
| contact_name | VARCHAR(50) | 联系人姓名 | 否 |
| contact_phone | VARCHAR(20) | 联系人电话 | 否 |
| contact_email | VARCHAR(100) | 联系人邮箱 | 否 |
| status | VARCHAR(20) | 状态（启用/禁用） | 是 |
| created_at | DATETIME | 创建时间 | 是 |
| updated_at | DATETIME | 更新时间 | 是 |

**使用场景**：
- 系统初始化时，配置对接的保司信息
- 产品配置时，关联到对应的保司
- 责任配置时，关联到对应的保司

---

### 2.3 保司责任表（company_liabilities）

**设计目的**：存储每个保司定义的责任类型，责任跟随保司。

**为什么这样设计**：
- **责任是保司级别的**：不同保司的责任虽然名称可能相似，但含义可能完全不同
- 例如：利宝的"意外身故伤残"和平安的"意外身故伤残"可能是不同的责任定义
- 每个保司有自己独立的责任体系
- 便于保司级别的责任管理和配置

**字段说明**：

| 字段名 | 类型 | 说明 | 是否必填 |
|--------|------|------|----------|
| liability_id | BIGINT | 责任ID（主键，自增） | 是 |
| company_id | BIGINT | 保司ID（外键） | 是 |
| liability_code | VARCHAR(50) | 责任代码（保司定义，如：DEATH_BENEFIT） | 是 |
| liability_name | VARCHAR(100) | 责任名称（如：意外身故伤残保险金） | 是 |
| liability_type | VARCHAR(50) | 责任类型（身故/医疗/津贴/其他） | 是 |
| unit_type | VARCHAR(20) | 单位类型（金额/天数/比例等） | 是 |
| description | TEXT | 责任描述（保司定义的具体含义） | 否 |
| status | VARCHAR(20) | 状态（启用/禁用） | 是 |
| created_at | DATETIME | 创建时间 | 是 |
| updated_at | DATETIME | 更新时间 | 是 |

**使用场景**：
- 通过配置文件导入保司的责任定义
- 配置产品时，从该保司的责任中选择
- 录单时，展示该保司产品的责任选项

---

### 2.4 保司产品表（insurance_products）

**设计目的**：存储各保司的产品信息，通过配置文件导入。

**为什么这样设计**：
- 经纪公司需要管理多个保司的产品
- 产品信息通过配置文件批量导入，避免手动逐个配置
- 产品关联到保司，每个保司有独立的产品体系

**字段说明**：

| 字段名 | 类型 | 说明 | 是否必填 |
|--------|------|------|----------|
| product_id | BIGINT | 产品ID（主键，自增） | 是 |
| company_id | BIGINT | 保司ID（外键） | 是 |
| product_code | VARCHAR(50) | 产品代码（保司定义） | 是 |
| product_name | VARCHAR(200) | 产品名称 | 是 |
| registration_no | VARCHAR(100) | 产品注册号 | 否 |
| registration_name | VARCHAR(200) | 产品注册名称 | 否 |
| product_type | VARCHAR(50) | 产品类型（雇主责任险/团体意外险等） | 是 |
| config_source | VARCHAR(100) | 配置来源（配置文件路径或导入批次） | 否 |
| status | VARCHAR(20) | 状态（启用/禁用） | 是 |
| effective_date | DATE | 生效日期 | 否 |
| expiry_date | DATE | 失效日期 | 否 |
| created_at | DATETIME | 创建时间 | 是 |
| updated_at | DATETIME | 更新时间 | 是 |

**使用场景**：
- 通过配置文件批量导入产品信息
- 录单时，根据保司选择对应的产品
- 产品下架时，更新状态为"禁用"

---

### 2.5 产品方案表（product_plans）

**设计目的**：存储产品下的方案配置，一个产品有多个方案。通过配置文件导入。

**为什么这样设计**：
- **产品 → 方案：一对多关系**
- 一个产品可能有多个方案（如方案一、方案二、方案三等）
- 方案是产品的一部分，应该关联到产品
- 方案配置通过配置文件批量导入

**字段说明**：

| 字段名 | 类型 | 说明 | 是否必填 |
|--------|------|------|----------|
| plan_id | BIGINT | 方案ID（主键，自增） | 是 |
| product_id | BIGINT | 产品ID（外键） | 是 |
| plan_code | VARCHAR(50) | 方案代码（保司定义） | 是 |
| plan_name | VARCHAR(100) | 方案名称（如：方案一/方案二） | 是 |
| job_class_range | VARCHAR(50) | 职业类别范围（1~3类/4类/5类等） | 是 |
| duration_options | TEXT | 保障时间选项（JSON格式，如：["1年","6个月"]） | 是 |
| payment_type | VARCHAR(50) | 缴费方式（一次交清） | 是 |
| description | TEXT | 方案描述 | 否 |
| config_source | VARCHAR(100) | 配置来源（配置文件路径或导入批次） | 否 |
| status | VARCHAR(20) | 状态（启用/禁用） | 是 |
| created_at | DATETIME | 创建时间 | 是 |
| updated_at | DATETIME | 更新时间 | 是 |

**使用场景**：
- 通过配置文件批量导入产品方案配置
- 录单时，根据产品展示可选的方案列表
- 用户选择方案后，展示该方案下的责任选项

---

### 2.6 方案责任关联表（plan_liabilities）

**设计目的**：存储方案下的责任配置，一个方案有多个责任。通过配置文件导入。

**为什么这样设计**：
- **方案 → 责任：一对多关系**
- 一个方案包含多个责任（如：意外身故、医疗费用、住院津贴等）
- 每个责任在方案中有对应的保额选项
- 责任来自保司责任表，方案选择责任时从保司责任中选择
- 方案责任配置通过配置文件批量导入

**字段说明**：

| 字段名 | 类型 | 说明 | 是否必填 |
|--------|------|------|----------|
| id | BIGINT | 主键（自增） | 是 |
| plan_id | BIGINT | 方案ID（外键） | 是 |
| liability_id | BIGINT | 责任ID（外键，关联保司责任表） | 是 |
| is_required | BOOLEAN | 是否必选（true=必选，false=可选） | 是 |
| coverage_options | TEXT | 保额选项（JSON格式，如：["10万","30万","50万","80万","100万"]） | 是 |
| default_coverage | VARCHAR(50) | 默认保额（如：10万） | 否 |
| min_coverage | VARCHAR(50) | 最小保额 | 否 |
| max_coverage | VARCHAR(50) | 最大保额 | 否 |
| unit | VARCHAR(20) | 单位（元/天/比例等） | 是 |
| display_order | INT | 显示顺序 | 是 |
| config_source | VARCHAR(100) | 配置来源（配置文件路径或导入批次） | 否 |
| status | VARCHAR(20) | 状态（启用/禁用） | 是 |
| created_at | DATETIME | 创建时间 | 是 |
| updated_at | DATETIME | 更新时间 | 是 |

**使用场景**：
- 通过配置文件批量导入方案责任配置
- 录单时，用户选择方案后，展示该方案下的责任和保额选项
- 用户选择责任和保额后，用于保费计算

---

### 2.7 投保方案实例表（application_plans）

**设计目的**：存储用户在投保时选择的方案实例，记录用户选择的具体责任和保额。

**为什么这样设计**：
- 方案模板（product_plans）定义了可选的责任和保额选项
- 用户投保时，从方案模板中选择具体的责任和保额值
- 需要记录用户选择的具体值，用于保费计算和保单生成
- 一个投保单可能有多个方案实例（如方案一、方案二）

**字段说明**：

| 字段名 | 类型 | 说明 | 是否必填 |
|--------|------|------|----------|
| instance_id | BIGINT | 方案实例ID（主键，自增） | 是 |
| application_id | BIGINT | 投保单ID（外键） | 是 |
| plan_id | BIGINT | 方案ID（外键，关联product_plans） | 是 |
| plan_name | VARCHAR(100) | 方案名称（如：方案一，从方案模板继承或用户自定义） | 是 |
| job_class | VARCHAR(20) | 职业类别（用户选择：1~3类/4类/5类等） | 是 |
| duration | VARCHAR(20) | 保障时间（用户选择：1年/6个月） | 是 |
| insured_count | INT | 该方案对应的被保人数 | 是 |
| plan_premium | DECIMAL(10,2) | 该方案的总保费 | 是 |
| created_at | DATETIME | 创建时间 | 是 |
| updated_at | DATETIME | 更新时间 | 是 |

**使用场景**：
- 用户选择方案后，创建方案实例记录
- 计算保费时，根据方案实例关联的责任和保额计算
- 保单详情页展示方案实例信息

---

### 2.8 方案实例责任关联表（plan_instance_liabilities）

**设计目的**：存储用户在方案实例中选择的具体责任和保额。

**为什么这样设计**：
- 方案模板（plan_liabilities）定义了可选的责任和保额选项
- 用户投保时，从方案模板的选项中选择具体的保额值
- 需要记录用户选择的具体值，用于保费计算和保单生成
- 一个方案实例包含多个责任选择

**字段说明**：

| 字段名 | 类型 | 说明 | 是否必填 |
|--------|------|------|----------|
| id | BIGINT | 主键（自增） | 是 |
| instance_id | BIGINT | 方案实例ID（外键，关联application_plans） | 是 |
| liability_id | BIGINT | 责任ID（外键，关联保司责任表） | 是 |
| coverage_amount | VARCHAR(50) | 保额（用户选择的具体值，如：30万/100元/天） | 是 |
| coverage_value | DECIMAL(12,2) | 保额数值（用于计算，如：300000） | 否 |
| unit | VARCHAR(20) | 单位（元/天/比例等） | 是 |
| is_selected | BOOLEAN | 是否选择（某些责任可能是可选的） | 是 |
| created_at | DATETIME | 创建时间 | 是 |

**使用场景**：
- 用户选择方案后，从方案的责任选项中选择具体的保额值
- 系统创建方案实例责任关联记录，存储用户选择的责任和保额
- 保费计算时，根据选择的责任和保额查询费率
- 保单详情页展示方案实例的责任明细

---

### 2.8 投保单表（applications）

**设计目的**：存储经纪公司为企业客户录入的投保申请信息，这是连接客户和保司接口的桥梁。

**为什么这样设计**：
- 投保单是业务流程的核心，所有后续操作都基于投保单
- 支持草稿状态，经纪公司可以先保存后提交
- 记录核保状态，便于跟踪投保进度
- 关联企业客户、保司、产品、方案、被保人等信息

**字段说明**：

| 字段名 | 类型 | 说明 | 是否必填 |
|--------|------|------|----------|
| application_id | BIGINT | 投保单ID（主键，自增） | 是 |
| application_no | VARCHAR(50) | 投保单号（系统生成，唯一） | 是 |
| company_id | BIGINT | 企业ID（外键） | 是 |
| product_name | VARCHAR(200) | 产品名称 | 是 |
| product_code | VARCHAR(50) | 产品代码 | 是 |
| total_premium | DECIMAL(12,2) | 总保费 | 是 |
| insured_count | INT | 被保人数 | 是 |
| effective_date | DATE | 生效起期 | 是 |
| expiry_date | DATE | 生效止期 | 是 |
| status | VARCHAR(20) | 状态（草稿/待核保/核保中/核保通过/核保拒绝/已承保/已取消） | 是 |
| draft_data | TEXT | 草稿数据（JSON格式，保存完整表单数据） | 否 |
| insurance_company | VARCHAR(100) | 承保公司名称 | 是 |
| insurance_company_code | VARCHAR(50) | 承保公司代码（外键，关联保司表） | 是 |
| submitted_at | DATETIME | 提交时间 | 否 |
| underwritten_at | DATETIME | 核保时间 | 否 |
| created_at | DATETIME | 创建时间 | 是 |
| updated_at | DATETIME | 更新时间 | 是 |

**使用场景**：
- 经纪公司为企业客户录入投保信息时，创建投保单记录（状态：草稿）
- 提交给保司后，更新状态为"待核保"，调用保司核保接口
- 核保通过后，更新状态为"核保通过"，等待承保
- 承保成功后，更新状态为"已承保"，并生成保单记录

---

**设计目的**：存储用户在方案实例中选择的具体责任和保额。

**为什么这样设计**：
- 方案模板（plan_liabilities）定义了可选的责任和保额选项
- 用户投保时，从方案模板的选项中选择具体的保额值
- 需要记录用户选择的具体值，用于保费计算和保单生成

**字段说明**：

| 字段名 | 类型 | 说明 | 是否必填 |
|--------|------|------|----------|
| id | BIGINT | 主键（自增） | 是 |
| instance_id | BIGINT | 方案实例ID（外键） | 是 |
| liability_id | BIGINT | 责任ID（外键，关联保司责任表） | 是 |
| coverage_amount | VARCHAR(50) | 保额（用户选择的具体值，如：30万/100元/天） | 是 |
| coverage_value | DECIMAL(12,2) | 保额数值（用于计算，如：300000） | 否 |
| unit | VARCHAR(20) | 单位（元/天/比例等） | 是 |
| is_selected | BOOLEAN | 是否选择（某些责任可能是可选的） | 是 |
| created_at | DATETIME | 创建时间 | 是 |

**使用场景**：
- 用户选择方案后，从方案的责任选项中选择具体的保额值
- 系统创建方案实例责任关联记录，存储用户选择的责任和保额
- 保费计算时，根据选择的责任和保额查询费率
- 保单详情页展示方案实例的责任明细

---

### 2.9 被保人表（insured_persons）

**设计目的**：存储被保人的详细信息，这是核保和承保的关键数据。

**为什么这样设计**：
- 被保人信息是核保的核心数据
- 支持批量导入，提高录入效率
- 记录职业类别和代码，用于保费计算和核保
- 支持批改操作（增员、减员、替换）

**字段说明**：

| 字段名 | 类型 | 说明 | 是否必填 |
|--------|------|------|----------|
| person_id | BIGINT | 被保人ID（主键，自增） | 是 |
| application_id | BIGINT | 投保单ID（外键） | 是 |
| instance_id | BIGINT | 所属方案实例ID（外键，关联application_plans） | 是 |
| name | VARCHAR(50) | 姓名 | 是 |
| id_type | VARCHAR(20) | 证件类型（身份证/护照等） | 是 |
| id_number | VARCHAR(50) | 证件号码 | 是 |
| gender | VARCHAR(10) | 性别（男/女） | 是 |
| birth_date | DATE | 出生日期 | 是 |
| phone | VARCHAR(20) | 手机号 | 否 |
| job_code | VARCHAR(50) | 职业代码 | 是 |
| job_category | VARCHAR(20) | 职业类别（1类/2类/3类/4类/5类） | 是 |
| job_name | VARCHAR(100) | 职业名称 | 是 |
| individual_premium | DECIMAL(10,2) | 个人保费（考虑职业加费） | 是 |
| status | VARCHAR(20) | 状态（待核保/已承保/已退保/已替换） | 是 |
| effective_date | DATE | 生效日期 | 否 |
| expiry_date | DATE | 失效日期 | 否 |
| created_at | DATETIME | 创建时间 | 是 |
| updated_at | DATETIME | 更新时间 | 是 |

**使用场景**：
- 投保第二步填写被保人信息时，批量保存到该表
- 核保时，将被保人信息发送给保司
- 批改时，新增、删除或更新被保人记录
- 保单详情页展示被保人清单

---

### 2.11 保单表（policies）

**设计目的**：存储承保成功后的正式保单信息，这是业务的核心资产。

**为什么这样设计**：
- 保单是承保后的正式记录，与投保单分离
- 保单号由保司返回，需要单独存储
- 支持保单状态管理（保障中/已过期/已退保等）
- 关联投保单，便于追溯

**字段说明**：

| 字段名 | 类型 | 说明 | 是否必填 |
|--------|------|------|----------|
| policy_id | BIGINT | 保单ID（主键，自增） | 是 |
| policy_no | VARCHAR(50) | 保单号（保司返回，唯一） | 是 |
| application_id | BIGINT | 投保单ID（外键） | 是 |
| company_id | BIGINT | 企业ID（外键） | 是 |
| product_name | VARCHAR(200) | 产品名称 | 是 |
| product_code | VARCHAR(50) | 产品代码 | 是 |
| total_premium | DECIMAL(12,2) | 总保费 | 是 |
| insured_count | INT | 被保人数 | 是 |
| effective_date | DATE | 生效起期 | 是 |
| expiry_date | DATE | 生效止期 | 是 |
| status | VARCHAR(20) | 状态（保障中/已过期/已退保/已终止） | 是 |
| insurance_company | VARCHAR(100) | 承保公司 | 是 |
| policy_file_url | VARCHAR(500) | 电子保单文件路径 | 否 |
| issued_at | DATETIME | 承保时间 | 是 |
| created_at | DATETIME | 创建时间 | 是 |
| updated_at | DATETIME | 更新时间 | 是 |

**使用场景**：
- 保司承保成功后，创建保单记录
- 经纪公司查看和管理客户的保单
- 保单详情页展示保单信息
- 续保时，关联原保单

---

### 2.12 批改申请表（endorsements）

**设计目的**：存储批改申请（增员、减员、替换）的信息。

**为什么这样设计**：
- 批改是保单生效后的重要操作
- 支持增员、减员、替换等多种批改类型
- 记录批改前后的变化，便于审核
- 批改需要保司审核，需要记录状态

**字段说明**：

| 字段名 | 类型 | 说明 | 是否必填 |
|--------|------|------|----------|
| endorsement_id | BIGINT | 批改申请ID（主键，自增） | 是 |
| endorsement_no | VARCHAR(50) | 批改单号（系统生成） | 是 |
| policy_id | BIGINT | 保单ID（外键） | 是 |
| endorsement_type | VARCHAR(20) | 批改类型（增员/减员/替换/信息变更） | 是 |
| add_count | INT | 新增人数 | 否 |
| remove_count | INT | 减少人数 | 否 |
| replace_count | INT | 替换人数 | 否 |
| premium_change | DECIMAL(10,2) | 保费变化（正数表示增加，负数表示减少） | 否 |
| reason | VARCHAR(500) | 批改原因 | 否 |
| status | VARCHAR(20) | 状态（待审核/审核中/审核通过/审核拒绝/已生效） | 是 |
| effective_date | DATE | 批改生效日期 | 否 |
| submitted_at | DATETIME | 提交时间 | 否 |
| approved_at | DATETIME | 审核时间 | 否 |
| created_at | DATETIME | 创建时间 | 是 |
| updated_at | DATETIME | 更新时间 | 是 |

**使用场景**：
- 用户提交批改申请时，创建批改记录
- 调用保司批改接口，更新审核状态
- 批改生效后，更新被保人表和保单信息

---

### 2.13 批改被保人明细表（endorsement_persons）

**设计目的**：记录批改涉及的具体被保人信息。

**为什么这样设计**：
- 批改可能涉及多个被保人
- 需要记录每个被保人的操作类型（新增/删除/替换）
- 替换操作需要记录原被保人和新被保人

**字段说明**：

| 字段名 | 类型 | 说明 | 是否必填 |
|--------|------|------|----------|
| id | BIGINT | 主键（自增） | 是 |
| endorsement_id | BIGINT | 批改申请ID（外键） | 是 |
| operation_type | VARCHAR(20) | 操作类型（新增/删除/替换） | 是 |
| old_person_id | BIGINT | 原被保人ID（替换时使用） | 否 |
| new_person_id | BIGINT | 新被保人ID（新增/替换时使用） | 否 |
| person_data | TEXT | 被保人信息（JSON格式，新增时使用） | 否 |
| created_at | DATETIME | 创建时间 | 是 |

**使用场景**：
- 批改时，记录每个被保人的操作
- 审核通过后，根据操作类型更新被保人表
- 批改详情页展示批改明细

---

### 2.14 续保申请表（renewals）

**设计目的**：存储续保申请的信息。

**为什么这样设计**：
- 续保是保单到期前的重要操作
- 续保可以调整方案和被保人
- 需要记录续保状态和生效日期

**字段说明**：

| 字段名 | 类型 | 说明 | 是否必填 |
|--------|------|------|----------|
| renewal_id | BIGINT | 续保申请ID（主键，自增） | 是 |
| renewal_no | VARCHAR(50) | 续保单号（系统生成） | 是 |
| original_policy_id | BIGINT | 原保单ID（外键） | 是 |
| new_policy_id | BIGINT | 新保单ID（续保成功后关联） | 否 |
| company_id | BIGINT | 企业ID（外键） | 是 |
| renewal_premium | DECIMAL(12,2) | 续保保费 | 是 |
| insured_count | INT | 续保被保人数 | 是 |
| effective_date | DATE | 续保生效日期 | 是 |
| expiry_date | DATE | 续保到期日期 | 是 |
| status | VARCHAR(20) | 状态（待审核/审核中/审核通过/审核拒绝/已承保） | 是 |
| submitted_at | DATETIME | 提交时间 | 否 |
| created_at | DATETIME | 创建时间 | 是 |
| updated_at | DATETIME | 更新时间 | 是 |

**使用场景**：
- 保单到期前，用户提交续保申请
- 调用保司续保接口，更新审核状态
- 续保成功后，创建新保单记录

---

### 2.15 发票表（invoices）

**设计目的**：存储发票信息，主要是附件管理。

**为什么这样设计**：
- 发票主要是附件文件，需要存储文件路径
- 记录发票的基本信息（发票号、金额等）
- 支持发票的查询和管理

**字段说明**：

| 字段名 | 类型 | 说明 | 是否必填 |
|--------|------|------|----------|
| invoice_id | BIGINT | 发票ID（主键，自增） | 是 |
| invoice_no | VARCHAR(50) | 发票号码 | 否 |
| policy_id | BIGINT | 保单ID（外键） | 是 |
| company_id | BIGINT | 企业客户ID（外键） | 是 |
| invoice_type | VARCHAR(20) | 发票类型（电子发票/纸质发票） | 是 |
| invoice_amount | DECIMAL(12,2) | 发票金额 | 是 |
| invoice_file_url | VARCHAR(500) | 发票文件路径（附件） | 否 |
| invoice_file_name | VARCHAR(200) | 发票文件名 | 否 |
| file_size | BIGINT | 文件大小（字节） | 否 |
| uploaded_at | DATETIME | 上传时间 | 否 |
| created_at | DATETIME | 创建时间 | 是 |
| updated_at | DATETIME | 更新时间 | 是 |

**使用场景**：
- 上传发票附件时，创建发票记录
- 查询和管理发票附件
- 下载发票文件

---

### 2.16 回执表（receipts）

**设计目的**：存储保单回执信息，主要是附件管理。

**为什么这样设计**：
- 回执主要是附件文件，需要存储文件路径
- 记录回执的基本信息（签收人、签收时间等）
- 支持回执的查询和管理

**字段说明**：

| 字段名 | 类型 | 说明 | 是否必填 |
|--------|------|------|----------|
| receipt_id | BIGINT | 回执ID（主键，自增） | 是 |
| receipt_no | VARCHAR(50) | 回执号 | 否 |
| policy_id | BIGINT | 保单ID（外键） | 是 |
| company_id | BIGINT | 企业客户ID（外键） | 是 |
| receipt_type | VARCHAR(20) | 回执类型（电子回执/纸质回执） | 是 |
| signer_name | VARCHAR(50) | 签收人姓名 | 否 |
| signer_phone | VARCHAR(20) | 签收人电话 | 否 |
| signed_at | DATETIME | 签收时间 | 否 |
| receipt_file_url | VARCHAR(500) | 回执文件路径（附件） | 否 |
| receipt_file_name | VARCHAR(200) | 回执文件名 | 否 |
| file_size | BIGINT | 文件大小（字节） | 否 |
| uploaded_at | DATETIME | 上传时间 | 否 |
| created_at | DATETIME | 创建时间 | 是 |
| updated_at | DATETIME | 更新时间 | 是 |

**使用场景**：
- 上传回执附件时，创建回执记录
- 查询和管理回执附件
- 下载回执文件

---

## 三、产品配置导入管理

### 3.1 配置文件导入记录表（config_imports）

**设计目的**：记录产品配置文件的导入历史，支持批量导入和版本管理。

**为什么这样设计**：
- 产品和对接信息通过配置文件批量导入
- 需要记录每次导入的时间、来源、状态等
- 支持导入失败的回滚和重新导入
- 便于追踪配置变更历史

**字段说明**：

| 字段名 | 类型 | 说明 | 是否必填 |
|--------|------|------|----------|
| import_id | BIGINT | 导入ID（主键，自增） | 是 |
| import_type | VARCHAR(50) | 导入类型（产品配置/接口配置/责任配置等） | 是 |
| file_name | VARCHAR(200) | 配置文件名 | 是 |
| file_path | VARCHAR(500) | 配置文件路径 | 是 |
| file_size | BIGINT | 文件大小（字节） | 否 |
| import_status | VARCHAR(20) | 导入状态（成功/失败/部分成功） | 是 |
| success_count | INT | 成功导入数量 | 否 |
| fail_count | INT | 失败数量 | 否 |
| error_message | TEXT | 错误信息 | 否 |
| imported_by | VARCHAR(50) | 导入人 | 否 |
| imported_at | DATETIME | 导入时间 | 是 |
| created_at | DATETIME | 创建时间 | 是 |

**使用场景**：
- 上传配置文件后，创建导入记录
- 导入过程中，更新导入状态和数量
- 导入失败时，记录错误信息
- 查询导入历史

---

### 3.2 产品方案模板表（product_plan_templates）

**设计目的**：存储不同保司的产品信息，支持多保司产品管理。

**为什么这样设计**：
- 系统可能对接多个保司（如利宝、平安等），每个保司有不同的产品
- 产品信息包括产品代码、名称、注册号等，这些是接口对接的关键字段
- 支持产品启用/禁用，便于产品管理
- 关联保司配置，明确产品的归属

**字段说明**：

| 字段名 | 类型 | 说明 | 是否必填 |
|--------|------|------|----------|
| product_id | BIGINT | 产品ID（主键，自增） | 是 |
| insurance_company_code | VARCHAR(50) | 保险公司代码（外键关联保司配置） | 是 |
| product_code | VARCHAR(50) | 产品代码（保司定义） | 是 |
| product_name | VARCHAR(200) | 产品名称 | 是 |
| registration_no | VARCHAR(100) | 产品注册号 | 否 |
| registration_name | VARCHAR(200) | 产品注册名称 | 否 |
| product_type | VARCHAR(50) | 产品类型（雇主责任险/团体意外险等） | 是 |
| status | VARCHAR(20) | 状态（启用/禁用） | 是 |
| effective_date | DATE | 生效日期 | 否 |
| expiry_date | DATE | 失效日期 | 否 |
| description | TEXT | 产品描述 | 否 |
| created_at | DATETIME | 创建时间 | 是 |
| updated_at | DATETIME | 更新时间 | 是 |

**使用场景**：
- 系统初始化时，配置各保司的产品信息
- 投保时，用户选择产品，系统根据产品代码调用对应保司接口
- 产品下架时，更新状态为"禁用"，禁止新投保

---


### 3.3 费率配置表（premium_rates）

**设计目的**：存储不同职业类别、责任保额组合对应的费率配置。通过配置文件导入。

**为什么这样设计**：
- 保费计算需要根据职业类别、责任类型、保额等参数查询费率
- 不同保司、不同产品的费率规则可能不同，需要分别配置
- 费率与保司责任关联，不同责任可能有不同的费率计算方式
- 费率配置通过配置文件批量导入

**字段说明**：

| 字段名 | 类型 | 说明 | 是否必填 |
|--------|------|------|----------|
| rate_id | BIGINT | 费率ID（主键，自增） | 是 |
| product_id | BIGINT | 产品ID（外键） | 是 |
| liability_id | BIGINT | 责任ID（外键，关联保司责任表） | 是 |
| job_class | VARCHAR(20) | 职业类别（1类/2类/3类/4类/5类） | 是 |
| coverage_amount | VARCHAR(50) | 保额（10万/30万/100元/天等） | 是 |
| base_rate | DECIMAL(10,4) | 基础费率 | 是 |
| rate_factor | DECIMAL(10,4) | 费率系数 | 是 |
| min_premium | DECIMAL(10,2) | 最低保费 | 否 |
| max_premium | DECIMAL(10,2) | 最高保费 | 否 |
| effective_date | DATE | 生效日期 | 是 |
| expiry_date | DATE | 失效日期 | 否 |
| config_source | VARCHAR(100) | 配置来源（配置文件路径或导入批次） | 否 |
| status | VARCHAR(20) | 状态（启用/禁用） | 是 |
| created_at | DATETIME | 创建时间 | 是 |
| updated_at | DATETIME | 更新时间 | 是 |

**使用场景**：
- 通过配置文件批量导入费率配置
- 保费计算时，根据职业类别、责任类型、保额查询对应的费率
- 费率调整时，创建新版本，旧版本自动失效

---

## 四、接口对接相关表

### 4.1 保司接口配置表（insurance_api_configs）

**设计目的**：存储各保司的接口配置信息，通过配置文件导入。

**为什么这样设计**：
- 经纪公司需要对接多个保司，每个保司的接口地址、密钥等不同
- 接口配置通过配置文件批量导入，避免手动逐个配置
- 支持接口版本管理和环境切换（测试/生产）
- 便于接口配置的统一管理

**字段说明**：

| 字段名 | 类型 | 说明 | 是否必填 |
|--------|------|------|----------|
| config_id | BIGINT | 配置ID（主键，自增） | 是 |
| company_id | BIGINT | 保司ID（外键） | 是 |
| company_code | VARCHAR(50) | 保司代码 | 是 |
| api_base_url | VARCHAR(200) | 接口基础地址 | 是 |
| api_version | VARCHAR(20) | 接口版本 | 是 |
| app_id | VARCHAR(100) | 应用ID | 是 |
| app_secret | VARCHAR(200) | 应用密钥（加密存储） | 是 |
| environment | VARCHAR(20) | 环境（test/production） | 是 |
| config_source | VARCHAR(100) | 配置来源（配置文件路径或导入批次） | 否 |
| status | VARCHAR(20) | 状态（启用/禁用） | 是 |
| created_at | DATETIME | 创建时间 | 是 |
| updated_at | DATETIME | 更新时间 | 是 |

**使用场景**：
- 通过配置文件批量导入保司接口配置
- 调用接口时，根据保司代码获取对应的配置
- 切换环境时，更新 environment 字段

---

### 4.2 渠道配置表（channels）

**设计目的**：存储渠道配置信息，支持多渠道对接。通过配置文件导入。

**为什么这样设计**：
- 经纪公司可能通过多个渠道对接保司（如乐选渠道等）
- 不同渠道可能有不同的接口地址、认证方式等
- 渠道配置通过配置文件批量导入
- 支持渠道的启用/禁用和切换

**字段说明**：

| 字段名 | 类型 | 说明 | 是否必填 |
|--------|------|------|----------|
| channel_id | BIGINT | 渠道ID（主键，自增） | 是 |
| channel_code | VARCHAR(50) | 渠道代码（唯一） | 是 |
| channel_name | VARCHAR(100) | 渠道名称 | 是 |
| company_id | BIGINT | 保司ID（外键） | 是 |
| api_base_url | VARCHAR(200) | 接口基础地址 | 是 |
| api_version | VARCHAR(20) | 接口版本 | 是 |
| app_id | VARCHAR(100) | 应用ID | 是 |
| app_secret | VARCHAR(200) | 应用密钥（加密存储） | 是 |
| environment | VARCHAR(20) | 环境（test/production） | 是 |
| config_source | VARCHAR(100) | 配置来源（配置文件路径或导入批次） | 否 |
| status | VARCHAR(20) | 状态（启用/禁用） | 是 |
| description | TEXT | 渠道描述 | 否 |
| created_at | DATETIME | 创建时间 | 是 |
| updated_at | DATETIME | 更新时间 | 是 |

**使用场景**：
- 通过配置文件批量导入渠道配置
- 调用接口时，根据渠道代码获取对应的配置
- 渠道切换时，更新渠道配置

---

### 4.3 接口字段映射表（api_field_mappings）

**设计目的**：存储系统字段与保司接口字段的映射关系。

**为什么这样设计**：
- 不同保司的接口字段命名可能不同，需要映射转换
- 支持字段格式转换（如日期格式、金额格式等）
- 便于接口对接和维护
- 支持字段的默认值和校验规则

**字段说明**：

| 字段名 | 类型 | 说明 | 是否必填 |
|--------|------|------|----------|
| mapping_id | BIGINT | 映射ID（主键，自增） | 是 |
| channel_id | BIGINT | 渠道ID（外键） | 是 |
| api_name | VARCHAR(100) | 接口名称（如：核保接口/承保接口） | 是 |
| system_field | VARCHAR(100) | 系统字段名 | 是 |
| api_field | VARCHAR(100) | 保司接口字段名 | 是 |
| field_type | VARCHAR(50) | 字段类型（string/number/date等） | 是 |
| format_rule | VARCHAR(200) | 格式转换规则（JSON格式） | 否 |
| default_value | VARCHAR(200) | 默认值 | 否 |
| is_required | BOOLEAN | 是否必填 | 是 |
| validation_rule | TEXT | 校验规则（JSON格式） | 否 |
| created_at | DATETIME | 创建时间 | 是 |
| updated_at | DATETIME | 更新时间 | 是 |

**使用场景**：
- 调用保司接口时，根据映射表转换字段名和格式
- 接口对接时，配置字段映射关系
- 字段调整时，更新映射配置

---

### 4.4 承保拦截规则表（underwriting_intercept_rules）

**设计目的**：存储承保接口的拦截规则，用于数据校验和业务规则检查。

**为什么这样设计**：
- 承保前需要进行数据校验和业务规则检查
- 不同保司可能有不同的拦截规则
- 支持规则的启用/禁用和优先级管理
- 拦截规则可以避免无效的接口调用，提高效率

**字段说明**：

| 字段名 | 类型 | 说明 | 是否必填 |
|--------|------|------|----------|
| rule_id | BIGINT | 规则ID（主键，自增） | 是 |
| channel_id | BIGINT | 渠道ID（外键） | 是 |
| rule_name | VARCHAR(100) | 规则名称 | 是 |
| rule_type | VARCHAR(50) | 规则类型（数据校验/业务规则/风控规则等） | 是 |
| check_field | VARCHAR(100) | 检查字段 | 是 |
| check_operator | VARCHAR(20) | 检查操作符（等于/大于/小于/包含等） | 是 |
| check_value | VARCHAR(200) | 检查值 | 是 |
| error_code | VARCHAR(50) | 错误代码 | 是 |
| error_message | VARCHAR(500) | 错误提示信息 | 是 |
| priority | INT | 优先级（数字越小优先级越高） | 是 |
| status | VARCHAR(20) | 状态（启用/禁用） | 是 |
| created_at | DATETIME | 创建时间 | 是 |
| updated_at | DATETIME | 更新时间 | 是 |

**使用场景**：
- 提交承保前，系统自动检查所有启用的拦截规则
- 规则拦截后，返回错误信息，阻止承保
- 规则调整时，更新规则配置，不影响已生效的保单

---

### 4.5 数据校验规则表（data_validation_rules）

**设计目的**：存储数据校验规则，用于字段级别的数据校验。

**为什么这样设计**：
- 不同字段有不同的校验规则（如身份证号格式、手机号格式等）
- 支持自定义校验规则和正则表达式
- 校验规则可以在前端和后端复用
- 便于校验规则的统一管理

**字段说明**：

| 字段名 | 类型 | 说明 | 是否必填 |
|--------|------|------|----------|
| validation_id | BIGINT | 校验规则ID（主键，自增） | 是 |
| field_name | VARCHAR(100) | 字段名称 | 是 |
| field_type | VARCHAR(50) | 字段类型 | 是 |
| validation_type | VARCHAR(50) | 校验类型（格式校验/长度校验/范围校验等） | 是 |
| validation_rule | TEXT | 校验规则（正则表达式或JSON格式） | 是 |
| error_message | VARCHAR(500) | 错误提示信息 | 是 |
| is_required | BOOLEAN | 是否必填 | 是 |
| min_length | INT | 最小长度 | 否 |
| max_length | INT | 最大长度 | 否 |
| min_value | DECIMAL(10,2) | 最小值 | 否 |
| max_value | DECIMAL(10,2) | 最大值 | 否 |
| status | VARCHAR(20) | 状态（启用/禁用） | 是 |
| created_at | DATETIME | 创建时间 | 是 |
| updated_at | DATETIME | 更新时间 | 是 |

**使用场景**：
- 用户填写表单时，前端根据校验规则实时校验
- 提交数据时，后端再次校验，确保数据正确
- 校验规则调整时，更新规则配置

---

### 4.6 保司接口调用日志表（insurance_api_logs）

**设计目的**：记录所有与保司接口的交互日志，用于问题排查和审计。

**为什么这样设计**：
- 接口调用可能出现异常，需要完整的日志记录
- 支持问题回溯和性能分析
- 满足合规要求，记录所有关键操作

**字段说明**：

| 字段名 | 类型 | 说明 | 是否必填 |
|--------|------|------|----------|
| log_id | BIGINT | 日志ID（主键，自增） | 是 |
| insurance_company | VARCHAR(100) | 保险公司 | 是 |
| api_name | VARCHAR(100) | 接口名称（如：核保接口/承保接口） | 是 |
| api_url | VARCHAR(500) | 接口地址 | 是 |
| request_method | VARCHAR(10) | 请求方法（POST/GET） | 是 |
| request_headers | TEXT | 请求头（JSON格式） | 否 |
| request_body | TEXT | 请求体（JSON格式） | 否 |
| response_status | INT | 响应状态码 | 否 |
| response_body | TEXT | 响应体（JSON格式） | 否 |
| error_message | TEXT | 错误信息 | 否 |
| execution_time | INT | 执行时间（毫秒） | 否 |
| business_id | VARCHAR(50) | 业务ID（投保单号/保单号等） | 否 |
| business_type | VARCHAR(50) | 业务类型（投保/批改/续保等） | 否 |
| created_at | DATETIME | 创建时间 | 是 |

**使用场景**：
- 每次调用保司接口时，记录请求和响应
- 接口异常时，通过日志排查问题
- 定期分析接口调用情况，优化性能

---

### 4.7 保司接口任务表（insurance_api_tasks）

**设计目的**：管理需要调用保司接口的异步任务。

**为什么这样设计**：
- 接口调用可能耗时较长，需要异步处理
- 支持任务重试机制
- 记录任务状态，便于监控和管理

**字段说明**：

| 字段名 | 类型 | 说明 | 是否必填 |
|--------|------|------|----------|
| task_id | BIGINT | 任务ID（主键，自增） | 是 |
| task_type | VARCHAR(50) | 任务类型（核保/承保/批改/续保等） | 是 |
| insurance_company | VARCHAR(100) | 保险公司 | 是 |
| business_id | VARCHAR(50) | 业务ID | 是 |
| request_data | TEXT | 请求数据（JSON格式） | 是 |
| response_data | TEXT | 响应数据（JSON格式） | 否 |
| status | VARCHAR(20) | 状态（待处理/处理中/成功/失败） | 是 |
| retry_count | INT | 重试次数 | 是 |
| max_retry | INT | 最大重试次数 | 是 |
| error_message | TEXT | 错误信息 | 否 |
| scheduled_at | DATETIME | 计划执行时间 | 是 |
| started_at | DATETIME | 开始时间 | 否 |
| completed_at | DATETIME | 完成时间 | 否 |
| created_at | DATETIME | 创建时间 | 是 |
| updated_at | DATETIME | 更新时间 | 是 |

**使用场景**：
- 提交核保时，创建异步任务
- 定时任务扫描待处理任务，调用接口
- 任务失败时，自动重试或人工处理

---

## 五、系统管理表

### 4.1 用户表（users）

**设计目的**：存储系统用户信息。

**字段说明**：

| 字段名 | 类型 | 说明 | 是否必填 |
|--------|------|------|----------|
| user_id | BIGINT | 用户ID（主键，自增） | 是 |
| username | VARCHAR(50) | 用户名（手机号） | 是 |
| password_hash | VARCHAR(200) | 密码哈希 | 是 |
| phone | VARCHAR(20) | 手机号 | 是 |
| email | VARCHAR(100) | 邮箱 | 否 |
| role | VARCHAR(20) | 角色（customer/admin） | 是 |
| status | VARCHAR(20) | 状态（正常/禁用） | 是 |
| last_login_at | DATETIME | 最后登录时间 | 否 |
| created_at | DATETIME | 创建时间 | 是 |
| updated_at | DATETIME | 更新时间 | 是 |

---

### 4.2 操作日志表（operation_logs）

**设计目的**：记录用户的关键操作，用于审计和问题排查。

**字段说明**：

| 字段名 | 类型 | 说明 | 是否必填 |
|--------|------|------|----------|
| log_id | BIGINT | 日志ID（主键，自增） | 是 |
| user_id | BIGINT | 用户ID（外键） | 是 |
| operation_type | VARCHAR(50) | 操作类型（创建投保单/提交核保/申请批改等） | 是 |
| business_id | VARCHAR(50) | 业务ID | 否 |
| operation_desc | VARCHAR(500) | 操作描述 | 否 |
| ip_address | VARCHAR(50) | IP地址 | 否 |
| user_agent | VARCHAR(500) | 用户代理 | 否 |
| created_at | DATETIME | 创建时间 | 是 |

---

## 六、数据库使用计划

### 5.1 一期接口对接流程（绿色标记接口）

根据业务优先级，一期需要对接以下核心接口：

#### 1. 核保接口
**使用流程**：
1. 用户在系统填写投保信息，创建 `applications` 记录（状态：草稿）
2. 用户选择产品和方案：
   - 系统从 `insurance_products` 表查询产品列表
   - 用户选择产品后，系统从 `product_plans` 表查询方案列表
   - 用户选择方案后，系统展示方案的保额选项等配置
3. 用户填写被保人信息，系统根据 `premium_rates` 表计算保费
4. 用户点击"立即投保"，更新状态为"待核保"
5. **数据校验**：
   - 系统查询 `data_validation_rules` 表，校验字段格式
   - 校验通过后，继续下一步
6. 系统创建 `insurance_api_tasks` 任务（任务类型：核保）
7. **数据转换**：
   - 系统查询 `channels` 表，获取渠道配置
   - 系统查询 `api_field_mappings` 表，转换字段名和格式
8. 异步任务调用保司核保接口，记录到 `insurance_api_logs`
9. 核保通过后，更新 `applications` 状态为"核保通过"
10. 核保拒绝后，更新状态为"核保拒绝"，记录拒绝原因

**涉及表**：
- `applications`：存储投保单信息
- `insurance_products`：保司产品表（新增）
- `product_plans`：产品方案配置表（新增）
- `premium_rates`：费率配置表（新增）
- `data_validation_rules`：数据校验规则表（新增）
- `channels`：渠道配置表（新增）
- `api_field_mappings`：接口字段映射表（新增）
- `insurance_api_tasks`：管理异步任务
- `insurance_api_logs`：记录接口调用日志

#### 2. 承保接口（含拦截规则）
**使用流程**：
1. 核保通过后，系统自动创建承保任务
2. **拦截规则检查**（重要）：
   - 系统查询 `underwriting_intercept_rules` 表，获取所有启用的拦截规则
   - 按照优先级顺序检查规则
   - 检查投保单数据是否符合规则（如被保人数、保费范围、职业类别等）
   - 如果规则拦截，记录拦截原因，更新任务状态为"失败"，返回错误信息
   - 如果所有规则通过，继续下一步
3. **数据转换**：
   - 系统查询 `api_field_mappings` 表，获取字段映射关系
   - 将系统字段转换为保司接口字段
   - 进行数据格式转换（如日期格式、金额格式等）
4. 调用保司承保接口，传入转换后的数据
5. 承保成功后，保司返回保单号
6. 创建 `policies` 记录，关联投保单
7. 更新 `applications` 状态为"已承保"

**涉及表**：
- `applications`：投保单表
- `policies`：保单表
- `insurance_api_tasks`：任务管理
- `insurance_api_logs`：接口日志
- `underwriting_intercept_rules`：承保拦截规则表（新增）
- `api_field_mappings`：接口字段映射表（新增）
- `channels`：渠道配置表（新增）

#### 3. 批改接口（增员/减员）
**使用流程**：
1. 用户在保单详情页点击"保全批改"
2. 选择批改类型（增员/减员），填写被保人信息
3. 创建 `endorsements` 记录（状态：待审核）
4. 创建批改任务，调用保司批改接口
5. 批改通过后，更新被保人表，更新保单保费
6. 更新 `endorsements` 状态为"已生效"

**涉及表**：
- `endorsements`：批改申请表
- `endorsement_persons`：批改被保人明细表
- `insured_persons`：被保人表
- `policies`：保单表

#### 4. 保单查询接口
**使用流程**：
1. 用户在保单列表页查询保单
2. 系统先从本地 `policies` 表查询
3. 需要同步最新状态时，调用保司查询接口
4. 更新本地保单状态和相关信息

**涉及表**：
- `policies`：保单表
- `insurance_api_logs`：接口日志

#### 5. 电子保单下载接口
**使用流程**：
1. 用户在保单详情页点击"下载电子保单"
2. 调用保司下载接口，获取保单文件
3. 保存文件到服务器，更新 `policies.policy_file_url`
4. 返回文件给用户下载

**涉及表**：
- `policies`：保单表

---

### 5.2 数据流转示例

**完整投保流程**：

1. **用户填写信息**
   - 创建 `companies` 记录（如果企业客户不存在）
   - 用户选择产品和方案：
     - 系统从 `product_plans` 表查询产品下的方案列表
     - 用户选择方案后，系统从 `plan_liabilities` 表查询方案下的责任和保额选项
     - 用户从可选选项中选择具体的保额值
   - 创建 `applications` 记录（投保单，状态：草稿）
   - 创建 `application_plans` 记录（方案实例）
   - 创建 `plan_instance_liabilities` 记录（存储用户选择的责任和保额）
   - 创建 `insured_persons` 记录（被保人信息，关联到方案实例）

2. **提交核保**
   - 更新 `applications` 状态为"待核保"
   - 创建 `insurance_api_tasks` 任务
   - 异步调用保司核保接口
   - 记录 `insurance_api_logs`
   - 更新 `applications` 状态为"核保通过"

3. **承保**
   - 创建承保任务
   - 调用保司承保接口
   - 创建 `policies` 记录
   - 更新 `applications` 状态为"已承保"

4. **后续操作**
   - 批改：创建 `endorsements` 记录，调用批改接口
   - 续保：创建 `renewals` 记录，调用续保接口
   - 发票：创建 `invoices` 记录，调用发票接口

---

### 5.3 数据一致性保障

1. **事务处理**：关键操作使用数据库事务，确保数据一致性
2. **状态机管理**：使用状态字段控制业务流程，避免状态混乱
3. **接口幂等性**：接口调用支持幂等，避免重复操作
4. **数据校验**：接口调用前后，校验数据完整性
5. **异常处理**：接口失败时，记录错误信息，支持人工处理

---

### 5.4 性能优化建议

1. **索引设计**：
   - `applications.application_no`：唯一索引
   - `policies.policy_no`：唯一索引
   - `applications.company_id`：普通索引
   - `applications.status`：普通索引
   - `insurance_api_logs.business_id`：普通索引
   - `insurance_api_logs.created_at`：普通索引
   - `insurance_products.company_id`：普通索引
   - `insurance_products.product_code`：普通索引
   - `company_liabilities.company_id`：普通索引
   - `company_liabilities.liability_code`：普通索引（保司内唯一）
   - `product_plans.product_id`：普通索引
   - `plan_liabilities.plan_id`：普通索引
   - `plan_liabilities.liability_id`：普通索引
   - `application_plans.application_id`：普通索引
   - `application_plans.plan_id`：普通索引
   - `plan_instance_liabilities.instance_id`：普通索引
   - `plan_instance_liabilities.liability_id`：普通索引
   - `premium_rates.product_id`：普通索引
   - `premium_rates.liability_id`：普通索引
   - `premium_rates.job_class`：普通索引
   - `channels.channel_code`：唯一索引
   - `channels.insurance_company_code`：普通索引
   - `api_field_mappings.channel_id`：普通索引
   - `api_field_mappings.api_name`：普通索引
   - `underwriting_intercept_rules.channel_id`：普通索引
   - `underwriting_intercept_rules.status`：普通索引
   - `underwriting_intercept_rules.priority`：普通索引

2. **数据归档**：
   - 定期归档历史日志数据
   - 已过期保单可以归档到历史表

3. **缓存策略**：
   - 保司接口配置信息可以缓存
   - 常用查询结果可以缓存

---

## 七、责任管理设计说明

### 7.1 责任管理的设计理念

责任管理采用三层架构设计：

1. **责任定义层**（`insurance_liabilities` 表）
   - 定义所有可能的责任类型
   - 责任是独立的业务概念，与保司、产品无关
   - 例如：意外身故伤残保险金、医疗费用保险金、住院津贴等

2. **产品责任配置层**（`product_liabilities` 表）
   - 定义某个产品支持哪些责任
   - 定义每个责任在该产品中的保额选项
   - 不同产品可能有不同的责任组合和保额选项

3. **方案责任选择层**（`plan_liabilities` 表）
   - 存储用户在方案中选择的具体责任和保额
   - 用户从产品责任配置的选项中选择

### 7.2 为什么这样设计

**传统设计的不足**：
- 如果责任直接存储在方案表中，会导致：
  - 不同产品需要重复定义相同的责任
  - 新增责任类型需要修改表结构
  - 责任和保额选项无法灵活配置

**新设计的优势**：
1. **责任统一管理**：所有责任类型在一个表中定义，便于维护
2. **产品灵活配置**：不同产品可以选择不同的责任组合，每个责任有不同的保额选项
3. **易于扩展**：新增责任类型时，只需在责任表中添加，然后在产品责任关联表中配置
4. **符合业务逻辑**：责任是产品的一部分，方案只是选择了某些责任和保额

### 7.3 责任管理的使用流程

#### 7.3.1 系统初始化（通过配置文件导入）

1. **导入保司责任**
   - 通过配置文件批量导入各保司的责任定义
   - 存储在 `company_liabilities` 表中
   - 例如：利宝的责任、平安的责任等

2. **导入产品方案**
   - 通过配置文件批量导入产品下的方案
   - 存储在 `product_plans` 表中
   - 例如：利宝产品A有方案一、方案二等

3. **导入方案责任配置**
   - 通过配置文件批量导入方案下的责任配置
   - 存储在 `plan_liabilities` 表中
   - 定义每个方案包含哪些责任，以及每个责任的保额选项

#### 7.3.2 用户投保流程

1. **选择产品**
   - 系统从 `product_plans` 表查询产品下的方案列表
   - 展示可选的方案（如方案一、方案二）

2. **选择方案**
   - 用户选择方案后，系统从 `plan_liabilities` 表查询方案下的责任列表
   - 展示每个责任的保额选项

3. **选择责任和保额**
   - 用户从方案的责任选项中选择具体的保额值
   - 例如：选择意外身故30万、医疗费用2万、住院津贴100元/天

4. **创建方案实例**
   - 系统创建 `application_plans` 记录（方案实例）
   - 系统创建 `plan_instance_liabilities` 记录（存储选择的责任和保额）

5. **计算保费**
   - 根据选择的责任、保额、职业类别查询 `premium_rates` 表
   - 计算每个责任的保费，汇总得到总保费

### 7.4 责任管理的优势示例

**场景1：不同保司不同责任**
- 利宝的"意外身故伤残"和平安的"意外身故伤残"虽然名称相似，但含义可能不同
- 新设计：责任跟随保司，每个保司有独立的责任体系，互不干扰

**场景2：产品 → 方案 → 责任层级关系**
- 产品A有方案一、方案二
- 方案一包含责任1、责任2、责任3
- 方案二包含责任1、责任4、责任5
- 新设计：通过层级关系清晰管理，符合业务逻辑

**场景3：同一方案不同保额选项**
- 方案一的意外身故可选：10万、30万、50万
- 方案二的意外身故可选：20万、40万、60万
- 新设计：通过 `plan_liabilities` 表的 `coverage_options` 字段灵活配置

### 7.5 数据关系示例

**company_liabilities 表示例**（利宝保司）：
- 责任1：意外身故伤残保险金（LIBO_DEATH_BENEFIT）
- 责任2：医疗费用保险金（LIBO_MEDICAL_BENEFIT）
- 责任3：意外每日住院津贴（LIBO_DAILY_HOSPITAL）

**product_plans 表示例**（利宝产品A）：
- 方案1：方案一
- 方案2：方案二

**plan_liabilities 表示例**（方案一）：
- 责任1：意外身故伤残保险金，保额选项：["10万","30万","50万","80万","100万"]
- 责任2：医疗费用保险金，保额选项：["1万","2万","5万","10万"]
- 责任3：意外每日住院津贴，保额选项：["100元/天"]

**plan_instance_liabilities 表示例**（用户选择的方案一实例）：
- 责任1：意外身故伤残保险金，保额：30万（用户选择）
- 责任2：医疗费用保险金，保额：2万（用户选择）
- 责任3：意外每日住院津贴，保额：100元/天（用户选择）

---

## 八、承保拦截规则使用说明

### 7.1 拦截规则的作用

承保拦截规则是系统在调用保司承保接口前，对数据进行校验和业务规则检查的机制。它的主要作用是：

1. **数据校验**：检查必填字段是否填写、字段格式是否正确
2. **业务规则检查**：检查是否符合保司的业务规则（如被保人数限制、保费范围等）
3. **风控检查**：检查企业风控等级、被保人职业类别等风控信息
4. **提高效率**：在本地拦截不符合规则的数据，避免无效的接口调用

### 7.2 拦截规则的执行流程

1. **用户提交承保申请**
   - 系统检查投保单状态，确保已通过核保
   - 系统检查所有启用的拦截规则

2. **规则检查**
   - 按照优先级顺序检查规则
   - 如果规则拦截，返回错误信息，停止承保流程
   - 如果所有规则通过，继续承保流程

3. **调用承保接口**
   - 规则检查通过后，调用保司承保接口
   - 记录接口调用日志

### 7.3 拦截规则的配置

拦截规则可以通过管理后台配置，支持以下配置项：

- **规则名称**：便于识别和管理
- **规则类型**：数据校验/业务规则/风控规则等
- **检查字段**：要检查的字段名
- **检查操作符**：等于/大于/小于/包含/正则匹配等
- **检查值**：用于比较的值
- **错误信息**：拦截时返回的错误提示
- **优先级**：规则执行的顺序
- **状态**：启用/禁用

### 7.4 常见拦截规则示例

1. **被保人数限制**：检查被保人数是否在允许范围内（如：1-100人）
2. **保费范围检查**：检查总保费是否在允许范围内
3. **职业类别检查**：检查被保人职业类别是否符合产品要求
4. **企业风控检查**：检查企业风控等级，高风险企业可能被拦截
5. **证件号码格式检查**：检查身份证号、统一社会信用代码等格式是否正确

---

## 九、产品方案配置使用说明

### 8.1 产品方案的作用

产品方案配置是系统管理不同保司产品及其方案的基础数据。它的主要作用是：

1. **产品管理**：统一管理各保司的产品信息
2. **方案展示**：根据产品展示对应的方案列表
3. **保费计算**：根据方案配置计算保费
4. **接口对接**：根据产品代码调用对应保司的接口

### 8.2 产品方案的配置流程

1. **配置保司产品**
   - 在保司产品表中添加产品信息
   - 填写产品代码、名称、注册号等关键信息
   - 设置产品状态为"启用"

2. **配置产品方案**
   - 在产品方案配置表中添加方案信息
   - 配置方案的保额选项、职业类别范围等
   - 设置方案状态为"启用"

3. **配置费率**
   - 在费率配置表中添加费率信息
   - 配置不同职业类别、保额组合对应的费率
   - 设置费率生效日期

### 8.3 产品方案的使用流程

1. **用户选择产品**
   - 系统根据保司展示产品列表
   - 用户选择产品后，系统加载对应的方案列表

2. **用户选择方案**
   - 系统根据产品展示方案列表
   - 用户选择方案后，系统展示方案的保额选项等配置

3. **保费计算**
   - 用户填写被保人信息后，系统根据方案和费率计算保费
   - 保费计算考虑职业类别、保额、人数等因素

---

## 十、渠道对接使用说明

### 9.1 渠道对接的作用

渠道对接是系统通过不同渠道对接保司的机制。它的主要作用是：

1. **多渠道支持**：支持通过不同渠道对接同一保司
2. **接口隔离**：不同渠道的接口配置相互独立
3. **灵活切换**：可以根据需要切换渠道
4. **统一管理**：统一管理各渠道的配置和状态

### 9.2 渠道对接的配置

1. **配置渠道信息**
   - 在渠道配置表中添加渠道信息
   - 填写渠道代码、名称、接口地址等
   - 配置渠道的认证信息（app_id、app_secret等）

2. **配置字段映射**
   - 在接口字段映射表中配置字段映射关系
   - 配置系统字段与保司接口字段的对应关系
   - 配置字段格式转换规则

3. **配置拦截规则**
   - 在承保拦截规则表中配置拦截规则
   - 配置数据校验和业务规则检查

### 9.3 渠道对接的使用流程

1. **选择渠道**
   - 系统根据保司和产品选择对应的渠道
   - 加载渠道的接口配置和字段映射

2. **数据转换**
   - 系统根据字段映射表转换数据格式
   - 调用保司接口前，进行数据校验和规则检查

3. **接口调用**
   - 系统调用渠道的接口
   - 记录接口调用日志和任务状态

---

## 十一、总结

本数据库设计覆盖了雇主责任险平台的核心业务流程，支持与保司接口的完整对接。设计遵循以下原则：

1. **业务完整性**：覆盖投保、核保、承保、批改、续保等全流程
2. **接口友好**：数据结构与保司接口字段对应，减少转换成本
3. **可追溯性**：完整的日志记录，便于问题排查
4. **可扩展性**：预留字段和表结构，便于后续功能扩展

一期优先对接核保、承保、批改、查询、下载等核心接口，后续可以根据业务需要逐步对接其他接口。

---

## 十二、关键设计亮点

### 12.1 责任独立管理
**设计亮点**：责任从方案中分离，采用三层架构管理。

**优势**：
- 责任统一管理，便于维护和扩展
- 产品灵活配置，不同产品可以选择不同的责任组合
- 方案只存储用户选择的责任和保额，结构清晰
- 新增责任类型时，无需修改表结构

**使用场景**：
- 系统初始化时，定义所有责任类型
- 配置产品时，关联产品支持的责任和保额选项
- 用户投保时，从产品责任选项中选择具体的保额
- 保费计算时，根据选择的责任和保额查询费率

---

### 12.2 多保司多产品支持

通过保司产品表、产品方案配置表、费率配置表，系统可以灵活支持多个保司的多个产品，每个产品可以有多个方案，每个方案有独立的费率配置。这种设计使得系统具有良好的扩展性，新增保司或产品时，只需要配置相应的数据，无需修改代码。

### 12.3 拦截规则机制

通过承保拦截规则表和数据校验规则表，系统在调用保司接口前进行数据校验和业务规则检查。这种设计可以：
- 提前发现数据问题，避免无效的接口调用
- 提高系统效率，减少接口调用次数
- 提供友好的错误提示，改善用户体验
- 支持规则的灵活配置，便于业务调整

### 12.4 渠道对接机制

通过渠道配置表和接口字段映射表，系统可以灵活支持多渠道对接。不同渠道可能有不同的接口地址、认证方式、字段命名等，通过配置化的方式管理，使得系统具有良好的适应性。

### 12.5 完整的日志和追溯

通过接口调用日志表、操作日志表、任务表等，系统记录了所有关键操作的完整信息。这种设计可以：
- 快速定位问题，通过日志追溯问题原因
- 满足合规要求，记录所有关键操作
- 支持性能分析，通过日志分析系统性能
- 支持审计，通过日志进行业务审计

### 12.6 状态机管理

通过状态字段控制业务流程，确保业务流程的正确性。例如：
- 投保单状态：草稿 → 待核保 → 核保中 → 核保通过 → 已承保
- 保单状态：保障中 → 已过期/已退保
- 批改状态：待审核 → 审核中 → 审核通过 → 已生效

这种设计可以避免状态混乱，确保业务流程的正确执行。

---

## 十三、实施建议

### 12.1 分阶段实施

建议分阶段实施数据库设计：

**第一阶段**：核心业务表
- 投保企业表、投保单表、被保人表、保单表
- 基础的业务流程支持

**第二阶段**：产品配置表
- 保司产品表、产品方案配置表、费率配置表
- 支持多保司多产品

**第三阶段**：接口对接表
- 渠道配置表、接口字段映射表、拦截规则表
- 支持接口对接和规则管理

**第四阶段**：日志和监控表
- 接口调用日志表、操作日志表、任务表
- 支持日志记录和问题排查

### 12.2 数据初始化

系统上线前，需要初始化以下数据：

1. **保司配置**：配置各保司的基本信息
2. **渠道配置**：配置各渠道的接口信息
3. **产品配置**：配置各保司的产品信息
4. **方案配置**：配置各产品的方案信息
5. **费率配置**：配置各方案的费率信息
6. **拦截规则**：配置承保拦截规则
7. **字段映射**：配置接口字段映射关系

### 12.3 数据维护

系统运行过程中，需要定期维护以下数据：

1. **费率更新**：根据保司要求更新费率配置
2. **规则调整**：根据业务需要调整拦截规则
3. **产品管理**：新增或下架产品
4. **日志归档**：定期归档历史日志数据

---

## 十四、注意事项

1. **数据一致性**：关键操作使用数据库事务，确保数据一致性
2. **接口幂等性**：接口调用支持幂等，避免重复操作
3. **异常处理**：接口失败时，记录错误信息，支持人工处理
4. **性能优化**：合理设计索引，提高查询性能
5. **数据安全**：敏感信息（如密钥）加密存储
6. **备份恢复**：定期备份数据，支持数据恢复

